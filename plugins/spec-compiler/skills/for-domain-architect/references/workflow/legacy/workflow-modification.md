# 修改流程详解

> **目标**：基于用户反馈或评估结果，迭代修改领域设计文档

---

## 流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          修改流程                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  输入：领域设计文档 + 问题列表                                            │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 1：问题定位                                                │    │
│  │   - 分析问题类型                                                │    │
│  │   - 定位问题章节                                                │    │
│  │   - 分析影响范围                                                │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 2：制定修改方案                                            │    │
│  │   - 明确修改目标                                                │    │
│  │   - 确定修改范围                                                │    │
│  │   - 评估影响范围                                                │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 3：增量修改                                                │    │
│  │   - 只修改问题章节                                              │    │
│  │   - 保持其他章节不变                                            │    │
│  │   - 更新相关引用                                                │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 4：影响分析                                                │    │
│  │   - 检查章节间引用                                              │    │
│  │   - 检查设计一致性                                              │    │
│  │   - 更新关联内容                                                │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 5：重新评分                                                │    │
│  │   - 只对修改的章节评分                                          │    │
│  │   - 检查修改后章节 ≥60?                                          │    │
│  │   - 重新计算总分                                                │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  总分 ≥ 90?                                                              │
│  ├─ 是 → 完成修改，输出最终文档                                          │
│  └─ 否 → 返回 Step 1，继续迭代                                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Step 1：问题定位

### 问题分类

| 问题类型 | 说明 | 示例 | 修改难度 |
|---------|------|------|---------|
| **设计问题** | 设计决策不合理 | 聚合边界不清晰 | 高 |
| **遗漏问题** | 缺少必要内容 | 缺少某个聚合 | 中 |
| **矛盾问题** | 设计决策冲突 | 约束互相冲突 | 高 |
| **命名问题** | 命名不符合规范 | 使用了驼峰命名 | 低 |
| **格式问题** | 格式不符合要求 | 缺少必要表格 | 低 |

### 定位方法

**按章节定位**：
1. 根据问题描述，判断属于哪个章节
2. 读取该章节内容
3. 定位具体位置

**按引用定位**：
1. 检查章节间的引用关系
2. 追踪影响范围
3. 确定需要同步修改的章节

### 问题定位模板

```markdown
## 问题定位报告

### 问题 {N}: {问题描述}

**问题类型**：
- [ ] 设计问题
- [ ] 遗漏问题
- [ ] 矛盾问题
- [ ] 命名问题
- [ ] 格式问题

**定位章节**：第{X}章 - {章节名称}

**具体位置**：
- 节：{节名称}
- 小节：{小节名称}
- 行号：{行号范围}

**当前内容**：
```
{当前的设计内容}
```

**影响分析**：
- 直接影响：{直接影响的其他内容}
- 间接影响：{可能影响的其他章节}
- 引用关系：{需要更新的引用}

**参考原则**：
- 原则文档：{相关原则文档}
- 原则条目：{具体原则条目}
```

---

## Step 2：制定修改方案

### 修改目标

**明确修改要达成的目标**：
- 修复什么问题？
- 达到什么标准？
- 如何验证修复成功？

### 修改范围

**确定修改的范围**：
- 必须修改的部分
- 可选修改的部分
- 不修改的部分

**修改原则**：
- **最小修改**：只修改必要的部分
- **保持一致**：保持整体设计一致
- **不影响其他**：避免引入新问题

### 影响评估

**评估修改的影响**：
1. **直接影响**：当前章节的直接变化
2. **间接影响**：其他章节可能的变化
3. **引用影响**：需要更新的引用关系

**影响评估模板**：

```markdown
## 影响评估

### 直接影响
- 修改内容：{具体修改内容}
- 影响范围：{当前章节内的影响}

### 间接影响
- 受影响的章节：
  - [ ] 第{X}章：{影响说明}
  - [ ] 第{Y}章：{影响说明}

### 引用更新
- 需要更新的引用：
  - [ ] {引用1}
  - [ ] {引用2}

### 风险评估
- 风险等级：{低/中/高}
- 风险说明：{具体风险}
- 应对措施：{应对方案}
```

### 修改方案模板

```markdown
## 修改方案

### 修改目标
{修改要达成的目标}

### 修改范围
- 必须修改：{必须修改的内容}
- 可选修改：{可选修改的内容}
- 不修改：{不修改的内容}

### 修改步骤
1. {步骤1}
2. {步骤2}
3. {步骤3}

### 验证标准
- [ ] {验证标准1}
- [ ] {验证标准2}
- [ ] {验证标准3}
```

---

## Step 3：增量修改

### 修改原则

**增量修改**：
- 只修改问题章节
- 保持其他章节不变
- 最小化修改范围

**保持一致**：
- 保持命名一致
- 保持格式一致
- 保持引用一致

### 修改类型

#### 1. 内容补充

**场景**：遗漏了必要的内容

**修改方法**：
1. 定位需要补充的位置
2. 按照模板格式补充内容
3. 更新相关引用

**示例**：
```markdown
## 修改前
### 聚合清单
| 聚合名称 | 聚合根 | 职责 |
|---------|-------|------|
| Membership | Membership | 会员管理 |

## 修改后
### 聚合清单
| 聚合名称 | 聚合根 | 职责 |
|---------|-------|------|
| Membership | Membership | 会员管理 |
| Coupon | Coupon | 点券管理 |
```

#### 2. 内容修正

**场景**：设计决策不合理

**修改方法**：
1. 分析问题原因
2. 修正设计决策
3. 更新相关引用
4. 重新验证

**示例**：
```markdown
## 修改前
- 聚合根：Membership
- 聚合边界：包含会员信息和点券信息

## 修改后
- 聚合根：Membership（会员聚合）
- 聚合根：Coupon（点券聚合）
- 聚合边界：会员聚合不包含点券信息
```

#### 3. 内容删除

**场景**：包含冗余或不合理的内容

**修改方法**：
1. 定位需要删除的内容
2. 检查是否有引用
3. 删除内容
4. 更新相关引用

**示例**：
```markdown
## 修改前
### 领域服务
- MembershipService：会员管理服务
- UserMembershipService：用户会员关系服务（冗余）

## 修改后
### 领域服务
- MembershipDomain：会员领域服务
```

#### 4. 命名修正

**场景**：命名不符合规范

**修改方法**：
1. 识别不符合规范的命名
2. 按照命名规范修正
3. 全局替换所有引用

**示例**：
```markdown
## 修改前
- 领域服务：MembershipService
- 应用服务：MembershipApplicationService
- 领域事件：MembershipActivated

## 修改后
- 领域服务：MembershipDomain
- 应用服务：MembershipApplication
- 领域事件：MembershipActivatedEvent
```

### 修改检查清单

- [ ] 修改内容是否符合目标？
- [ ] 修改是否引入新问题？
- [ ] 命名是否符合规范？
- [ ] 格式是否符合模板？
- [ ] 引用是否已更新？

---

## Step 4：影响分析

### 引用检查

**检查项**：
- [ ] 章节间引用是否正确？
- [ ] 表格引用是否正确？
- [ ] 代码示例引用是否正确？
- [ ] 章节编号是否正确？

**更新引用**：
- 更新章节编号
- 更新表格引用
- 更新代码示例
- 更新目录

### 一致性检查

**命名一致性**：
- [ ] 聚合命名一致
- [ ] 服务命名一致
- [ ] 事件命名一致
- [ ] 参数命名一致

**设计一致性**：
- [ ] 设计原则一致
- [ ] 设计模式一致
- [ ] 约束定义一致
- [ ] 用例设计一致

### 同步更新

**需要同步更新的内容**：
1. 目录（如果章节结构变化）
2. 跨章节引用（如果内容变化）
3. 相关表格（如果数据变化）
4. 代码示例（如果 API 变化）

---

## Step 5：重新评分

### 评分范围

**只对修改的章节评分**：
- 修改了哪个章节，就只评分哪个章节
- 未修改的章节保持原分数

### 评分标准

**使用与生成时相同的评分标准**：
- 第一章：`scoring/chapter-01-scoring.md`
- 第二章：`scoring/chapter-02-scoring.md`
- 第三章：`scoring/chapter-03-scoring.md`
- 第四章：`scoring/chapter-04-scoring.md`
- 第五章：`scoring/chapter-05-scoring.md`

### 评分结果

**修改章节评分**：
- ≥60 分 → 修改成功，检查总分
- <60 分 → 修改失败，返回 Step 2

**总分计算**：
```
总分 = Σ(未修改章节分数 × 权重) + Σ(修改后章节分数 × 权重)
```

**总分判断**：
- ≥90 分 → 修改完成，输出最终文档
- <90 分 → 继续修改，返回 Step 1

### 评分报告

```markdown
## 修改评分报告

### 修改章节评分

| 章节 | 修改前 | 修改后 | 评价 |
|------|-------|-------|------|
| 第{X}章 | XX分 | XX分 | {通过/未通过} |

### 总分计算

| 维度 | 得分 | 权重 | 加权得分 |
|------|------|------|----------|
| 第一章 | XX | 15% | XX |
| 第二章 | XX | 30% | XX |
| 第三章 | XX | 10% | XX |
| 第四章 | XX | 20% | XX |
| 第五章 | XX | 10% | XX |
| 设计一致性 | XX | 15% | XX |
| **总分** | - | - | **XX** |

### 结论

- [ ] 总分 ≥90 分，修改完成
- [ ] 总分 <90 分，需继续修改
```

---

## 迭代控制

### 迭代次数限制

**最大迭代次数**：10 次

**迭代次数计数**：
- 每次修改算一次迭代
- 累计迭代次数不超过 10 次

**超限处理**：
- 达到 10 次仍 <90 分
- 记录当前状态
- 输出问题报告
- 请求人工介入

### 迭代优化

**优先修改高分问题**：
- 优先修改影响大的问题
- 优先修改容易修改的问题
- 优先修改修改后效果明显的问题

**批量修改**：
- 如果多个问题在同一章节
- 可以一次性修改
- 减少迭代次数

---

## 修改输出

### 输出文档

**修改后的领域设计文档**：
- 文件名：`{功能名称}-领域设计文档-v{版本}.md`
- 版本号：每次修改递增

### 修改日志

**记录每次修改**：

```markdown
## 修改日志

### v1.0 (初始版本)
- 生成初始文档

### v1.1 (2024-XX-XX)
**修改章节**：第{X}章
**修改原因**：{修改原因}
**修改内容**：
- 修改1：{具体修改}
- 修改2：{具体修改}
**修改前评分**：XX分
**修改后评分**：XX分
```

### 问题追踪

**记录未解决的问题**：
- 问题描述
- 问题原因
- 解决方案
- 当前状态

---

## 支持文档

### 章节指令
- [第一章指令](../chapters/chapter-01-bounded-context.md)
- [第二章指令](../chapters/chapter-02-aggregate.md)
- [第三章指令](../chapters/chapter-03-domain-service.md)
- [第四章指令](../chapters/chapter-04-application.md)
- [第五章指令](../chapters/chapter-05-starter.md)

### 设计原则
- [限界上下文原则](../principles/bounded-context.md)
- [聚合相关原则](../principles/aggregate.md)
- [领域服务原则](../principles/domain-service.md)
- [应用层原则](../principles/application.md)
- [入口层原则](../principles/starter.md)

### 评分标准
- [第一章评分标准](../scoring/chapter-01-scoring.md)
- [第二章评分标准](../scoring/chapter-02-scoring.md)
- [第三章评分标准](../scoring/chapter-03-scoring.md)
- [第四章评分标准](../scoring/chapter-04-scoring.md)
- [第五章评分标准](../scoring/chapter-05-scoring.md)
- [设计一致性评分标准](../scoring/design-consistency-scoring.md)
