# PDCA 章节生成流程

> **核心理念**：3×PDCA 循环 - 每章生成经历 3 个 PDCA 循环，确保质量

---

## 为什么需要 PDCA 循环

### 问题分析

| 问题 | 说明 | 影响 |
|------|------|------|
| **一次生成质量不稳定** | 可能遗漏重要内容 | 需要多次修改 |
| **问题发现太晚** | 最后才发现问题 | 成本高 |
| **质量维度单一** | 只关注评分 | 不全面 |

### PDCA 循环的优势

| 优势 | 说明 | 效果 |
|------|------|------|
| **逐步改进** | 每次解决一类问题 | 质量稳定提升 |
| **多维检测** | 原则→检查清单→评分 | 全面覆盖 |
| **早发现早修复** | 问题立即发现 | 成本低 |

---

## PDCA 循环结构

### 3 个 PDCA 循环

```
输入：PRD 摘要 + 前序章节摘要
  ↓
┌─────────────────────────────────────────┐
│ PDCA #1：Principles 检测                │
│   P: 准备上下文（PRD 摘要 + 原则）      │
│   D: 按照章节指南生成初稿               │
│   C: 使用 principles 检测问题           │
│   A: 修复检测到的问题                  │
└─────────────────────────────────────────┘
  ↓ 输出：初稿（v1）+ principles 问题记录
┌─────────────────────────────────────────┐
│ PDCA #2：Checklists 检测               │
│   P: 准备上下文（初稿 v1 + 检查清单）  │
│   D: 检查初稿是否满足检查清单           │
│   C: 使用 checklists 检测问题          │
│   A: 修复检测到的问题                  │
└─────────────────────────────────────────┘
  ↓ 输出：改进稿（v2）+ checklists 问题记录
┌─────────────────────────────────────────┐
│ PDCA #3：Scoring 检测                  │
│   P: 准备上下文（改进稿 v2 + 评分标准） │
│   D: 按照评分标准进行评分               │
│   C: 使用 scoring 检测问题并评分       │
│   A: 修复检测到的问题（直到 ≥60分）    │
└─────────────────────────────────────────┘
  ↓ 输出：终稿 + 评分报告（≥60分）
```

---

## PDCA #1：Principles 检测

### 目标

基于设计原则检测并修复问题，确保设计符合 DDD 原则。

### 流程

```
P（计划）
  1. 读取 PRD 摘要
  2. 读取前序章节摘要
  3. 读取章节指令
  4. 读取对应的设计原则
  ↓
D（执行）
  1. 基于指令和原则生成章节内容
  2. 确保内容符合原则要求
  3. 输出初稿（v1）
  ↓
C（检查）
  1. 读取对应章节的 principles 文件
  2. 逐条检查内容是否违反原则
  3. 生成 principles 问题记录
  ↓
A（处理）
  1. 分析问题记录
  2. 修复所有原则问题
  3. 输出问题记录文件
  4. 继续下一个 PDCA
```

### 输入

| 输入项 | 文件路径 | 说明 |
|-------|---------|------|
| PRD 摘要 | `output/prd-summary.md` | 功能概述、实体、流程 |
| 前序摘要 | `output/chapter-{N-1}-summary.md` | 前一章的关键内容 |
| 章节指令 | `chapters/chapter-xx.md` | 生成指令 |
| 设计原则 | `principles/xxx.md` | DDD 原则 |

### 输出

| 输出项 | 文件路径 | 说明 |
|-------|---------|------|
| 初稿 v1 | `output/chapter-xx-v1.md` | 生成的内容 |
| 问题记录 | `output/chapter-xx-issues-principles.md` | 原则问题清单 |

### 问题检测模板

```markdown
# Principles 问题记录 - 第 X 章

## 问题清单

### 问题 1：违反 XX 原则
- **原则**：{原则描述}
- **问题**：{具体问题}
- **位置**：{章节位置}
- **严重程度**：高/中/低
- **修复建议**：{建议方案}

## 修复结果
- ✅ 已修复：{问题列表}
```

---

## PDCA #2：Checklists 检测

### 目标

基于检查清单检测并修复问题，确保内容完整且符合要求。

### 流程

```
P（计划）
  1. 读取初稿 v1
  2. 读取对应检查清单
  ↓
D（执行）
  1. 逐项检查清单
  2. 检查内容是否满足
  3. 标记不满足项
  ↓
C（检查）
  1. 汇总检查结果
  2. 生成检查报告
  3. 确认所有必选项通过
  ↓
A（处理）
  1. 修复不满足项
  2. 重新检查
  3. 输出改进稿（v2）
  4. 输出检查问题记录
```

### 输入

| 输入项 | 文件路径 | 说明 |
|-------|---------|------|
| 初稿 v1 | `output/chapter-xx-v1.md` | PDCA #1 输出 |
| 检查清单 | `checklists/chapter-xx-checklist.md` | 检查清单 |

### 输出

| 输出项 | 文件路径 | 说明 |
|-------|---------|------|
| 改进稿 v2 | `output/chapter-xx-v2.md` | 修复后内容 |
| 问题记录 | `output/chapter-xx-issues-checklists.md` | 检查问题清单 |

### 检查清单模板

```markdown
# Checklist 问题记录 - 第 X 章

## 检查结果

### 通过项
- ✅ {检查项 1}
- ✅ {检查项 2}

### 不通过项
- ❌ {检查项 3}
  - **要求**：{具体要求}
  - **问题**：{具体问题}
  - **修复**：{修复方案}

## 修复结果
- 所有检查项已通过
```

---

## PDCA #3：Scoring 检测

### 目标

基于评分标准进行评分，确保达到及格线（≥60 分）。

### 流程

```
P（计划）
  1. 读取改进稿 v2
  2. 读取评分标准
  ↓
D（执行）
  1. 按照评分标准逐项评分
  2. 计算总分
  3. 生成评分报告
  ↓
C（检查）
  1. 检查总分是否 ≥60
  2. 分析失分项
  3. 生成问题清单
  ↓
A（处理）
  if (score ≥ 60) {
    输出终稿（v3）
    输出评分报告
    完成
  } else {
    修复问题项
    重新评分（最多 3 次）
  }
```

### 输入

| 输入项 | 文件路径 | 说明 |
|-------|---------|------|
| 改进稿 v2 | `output/chapter-xx-v2.md` | PDCA #2 输出 |
| 评分标准 | `scoring/chapter-xx-scoring.md` | 评分标准 |

### 输出

| 输出项 | 文件路径 | 说明 |
|-------|---------|------|
| 终稿 | `output/chapter-xx.md` | 最终内容 |
| 评分报告 | `output/chapter-xx-score.md` | 评分详情 |

### 评分报告模板

```markdown
# 评分报告 - 第 X 章

## 评分详情

| 评分项 | 满分 | 得分 | 说明 |
|-------|-----|-----|------|
| {项1} | 20 | 18 | {说明} |
| {项2} | 30 | 25 | {说明} |

## 总分：85/100

## 失分分析

### 失分项 1：{项名}
- **扣分**：-5
- **原因**：{原因}
- **改进建议**：{建议}

## 质量判定
✅ 及格（≥60 分），可以进入人工 Review
```

---

## 质量关卡处理

### 重试机制

每个 PDCA 循环最多重试 3 次：

```
for (let attempt = 1; attempt <= 3; attempt++) {
  const result = executePDCACycle();

  if (result.passed) {
    return result;
  }

  if (attempt < 3) {
    // 重试
    continue;
  } else {
    // 3 次重试后仍失败
    return {
      status: 'failed',
      message: `${attempt} 次重试后仍未通过，需要人工介入`
    };
  }
}
```

### 失败处理

| PDCA | 失败条件 | 处理方式 |
|-----|---------|---------|
| #1 | 3 次重试后仍有原则问题 | 记录问题，人工介入 |
| #2 | 3 次重试后仍有检查项不通过 | 记录问题，人工介入 |
| #3 | 3 次重试后评分仍 <60 | 记录问题，人工介入 |

---

## 完整示例：第二章生成

### PDCA #1 执行

```markdown
## 输入准备
- PRD 摘要：output/prd-summary.md
- 第一章摘要：output/chapter-01-summary.md
- 章节指令：chapters/chapter-02-aggregate.md
- 设计原则：principles/aggregate.md

## 执行步骤
1. 读取聚合原则
2. 识别聚合根（会员、订单、优惠券...）
3. 设计聚合边界
4. 设计聚合根行为
5. 生成初稿

## 检测问题
- 违反原则：聚合内强一致性，聚合外最终一致性
- 问题：订单聚合引用了外部聚合
- 修复：改为聚合根 ID 引用

## 输出
- 初稿 v1：output/chapter-02-v1.md
- 问题记录：output/chapter-02-issues-principles.md
```

### PDCA #2 执行

```markdown
## 输入准备
- 初稿 v1：output/chapter-02-v1.md
- 检查清单：checklists/chapter-02-checklist.md

## 检查结果
- ✅ 聚合根识别正确
- ✅ 聚合边界清晰
- ❌ 缺少事件发布设计

## 修复
- 添加事件发布设计

## 输出
- 改进稿 v2：output/chapter-02-v2.md
- 问题记录：output/chapter-02-issues-checklists.md
```

### PDCA #3 执行

```markdown
## 输入准备
- 改进稿 v2：output/chapter-02-v2.md
- 评分标准：scoring/chapter-02-scoring.md

## 评分结果
| 项 | 满分 | 得分 |
|---|-----|-----|
| 聚合根识别 | 20 | 18 |
| 聚合边界 | 20 | 17 |
| 行为设计 | 30 | 26 |
| 实体值对象 | 20 | 16 |
| 事件发布 | 10 | 8 |
| **总分** | **100** | **85** |

## 质量判定
✅ 及格（85 ≥ 60），可以进入人工 Review

## 输出
- 终稿：output/chapter-02.md
- 评分报告：output/chapter-02-score.md
```

---

## 进度显示

### PDCA 循环进度

```
==================================================
第二章：聚合设计 - PDCA 进度
==================================================
✅ PDCA #1：Principles 检测（3 问题 → 已修复）
✅ PDCA #2：Checklists 检测（2 项不通过 → 已修复）
🔄 PDCA #3：Scoring 检测（评分中...）
==================================================
当前评分：85/100（等待确认 ≥60）
```

### 单个 PDCA 内部进度

```
🔄 PDCA #3：Scoring 检测
  ✅ P: 准备上下文
  ✅ D: 执行评分
  ✅ C: 检查结果
  🔄 A: 处理问题（≥60? → 是）
  ↓
  即将完成...
```

---

## 最佳实践

### DO ✅

- ✅ 按顺序执行 3 个 PDCA 循环
- ✅ 每个 PDCA 都要完整执行 P-D-C-A
- ✅ 生成详细的问题记录
- ✅ 达到质量关卡才进入下一个 PDCA
- ✅ 失败后分析原因再重试

### DON'T ❌

- ❌ 跳过某个 PDCA 循环
- ❌ PDCA 内步骤不完整
- ❌ 不生成问题记录
- ❌ 不达到质量关卡就继续
- ❌ 盲目重试不分析原因

---

## 总结

通过 3×PDCA 循环：

1. **PDCA #1**：确保设计符合 DDD 原则
2. **PDCA #2**：确保内容完整且符合检查清单
3. **PDCA #3**：确保评分达到及格线（≥60 分）

每个 PDCA 循环都是一次完整的质量检测和改进，确保输出高质量的章节内容。
