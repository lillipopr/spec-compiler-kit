# 第三章评分标准：领域服务设计

> **满分**：100 分
> **及格分**：60 分
> **优秀线**：80 分
> **对应章节**：chapter-03-domain-service.md
> **对应原则**：domain-service.md

---

## 评分维度

| 维度 | 权重 | 评分要点 |
|------|------|---------|
| 领域服务识别 | 30 分 | 识别标准、与聚合根行为区分、决策树 |
| 领域服务设计 | 35 分 | 无状态原则、协调原则、命名规范 |
| 领域服务职责 | 20 分 | 跨聚合协调、复杂计算、值对象创建 |
| 与聚合根协作 | 15 分 | 调用聚合根行为、事务边界 |

---

## 一、领域服务识别（30 分）

### 1.1 识别标准（10 分）

**满分**：10 分

**评分标准**：
- 优秀（90-100分）：所有领域服务都通过识别标准正确判断
- 良好（80-89分）：90%以上领域服务判断正确
- 及格（60-79分）：70%以上领域服务判断正确
- 不及格（<60分）：低于70%领域服务判断正确

**检查项**：
- [ ] 涉及多个聚合（4分）：逻辑需要访问多个聚合
- [ ] 不属于特定实体（3分）：逻辑无法自然归属到某个实体
- [ ] 复杂计算（3分）：复杂算法或计算

**判断标准**：满足以上任一条件 → 领域服务候选

**扣分项**：
- 识别缺失：需要领域服务但未设计扣 3 分/处
- 识别错误：不需要领域服务却设计了扣 2 分/处

---

### 1.2 领域服务 vs 聚合根行为（12 分）

**满分**：12 分

**评分标准**：
- 优秀（90-100分）：完全正确区分领域服务和聚合根行为
- 良好（80-89分）：90%以上正确区分
- 及格（60-79分）：70%以上正确区分
- 不及格（<60分）：低于70%正确区分

**检查项**：
- [ ] 优先将行为放在聚合根中（4分）
- [ ] 范围区分（3分）：聚合根行为（单个聚合内）vs 领域服务（跨聚合或无自然归属）
- [ ] 状态修改（3分）：聚合根行为（修改聚合状态）vs 领域服务（不修改聚合状态或协调多个聚合）
- [ ] 示例正确（2分）：order.addItem() vs calculateDiscount(order, user)

**对比表**：
| 维度 | 聚合根行为 | 领域服务 |
|------|-----------|---------|
| 范围 | 单个聚合内 | 跨聚合或无自然归属 |
| 状态修改 | 修改聚合状态 | 不修改聚合状态（或协调多个聚合） |
| 示例 | order.addItem() | calculateDiscount(order, user) |

**扣分项**：
- 混淆：聚合根行为和领域服务混淆扣 3 分/处
- 应该在聚合根却放在领域服务扣 2 分/处
- 应该在领域服务却放在聚合根扣 2 分/处

---

### 1.3 识别决策树（8 分）

**满分**：8 分

**评分标准**：
- 优秀（90-100分）：使用决策树验证，所有服务都通过决策树
- 良好（80-89分）：90%以上服务通过决策树
- 及格（60-79分）：70%以上服务通过决策树
- 不及格（<60分）：低于70%服务通过决策树

**检查项**：
- [ ] 决策树使用（8分）：使用决策树验证每个服务

**决策树**：
```
这个逻辑是领域服务吗？
│
├─ 涉及多个聚合吗？
│   ├─ 是 → 领域服务
│   └─ 否 → 继续
│
├─ 属于某个实体吗？
│   ├─ 是 → 实体行为
│   └─ 否 → 继续
│
└─ 是复杂计算吗？
    ├─ 是 → 领域服务
    └─ 否 → 可能是值对象或简单函数
```

**扣分项**：
- 未使用决策树：未使用决策树验证扣 4 分
- 决策树应用错误：决策树应用错误扣 2 分/处

---

## 二、领域服务设计（35 分）

### 2.1 无状态原则（12 分）

**满分**：12 分

**评分标准**：
- 优秀（90-100分）：所有领域服务都是无状态的
- 良好（80-89分）：90%以上领域服务是无状态的
- 及格（60-79分）：70%以上领域服务是无状态的
- 不及格（<60分）：低于70%领域服务是无状态的

**检查项**：
- [ ] 不持有聚合的引用（6分）：领域服务不持有聚合的引用
- [ ] 方法接收参数（4分）：方法接收参数，返回结果
- [ ] 无实例变量（2分）：不使用实例变量存储状态

**示例**：
```typescript
// ✅ 正确：领域服务无状态
class MembershipDomain {
  transfer(from: Membership, to: Membership, amount: number): void {
    from.deductPoints(amount)
    to.addPoints(amount)
  }
}

// ❌ 错误：领域服务有状态
class MembershipDomain {
  private from: Membership
  private to: Membership

  setFrom(membership: Membership): void {
    this.from = membership  // 持有状态
  }
}
```

**扣分项**：
- 有状态：领域服务持有聚合引用扣 5 分/个
- 使用实例变量存储状态扣 3 分/个

---

### 2.2 协调原则（12 分）

**满分**：12 分

**评分标准**：
- 优秀（90-100分）：所有领域服务都正确协调多个聚合
- 良好（80-89分）：90%以上领域服务正确协调
- 及格（60-79分）：70%以上领域服务正确协调
- 不及格（<60分）：低于70%领域服务正确协调

**检查项**：
- [ ] 协调多个聚合（6分）：领域服务协调多个聚合
- [ ] 通过聚合根行为（6分）：通过调用聚合根行为来实现逻辑

**示例**：
```typescript
// ✅ 正确：领域服务协调，通过聚合根行为修改状态
class MembershipDomain {
  transfer(from: Membership, to: Membership, amount: number): void {
    from.deductPoints(amount)  // 调用聚合根行为
    to.addPoints(amount)        // 调用聚合根行为
  }
}

// ❌ 错误：领域服务直接修改状态
class MembershipDomain {
  transfer(from: Membership, to: Membership, amount: number): void {
    from.points -= amount  // 直接修改状态
    to.points += amount
  }
}
```

**扣分项**：
- 直接修改状态：领域服务直接修改聚合状态扣 5 分/处
- 未通过聚合根行为：未调用聚合根行为扣 3 分/处

---

### 2.3 命名规范（11 分）

**满分**：11 分

**评分标准**：
- 优秀（90-100分）：所有领域服务命名完全符合规范
- 良好（80-89分）：90%以上领域服务命名符合规范
- 及格（60-79分）：70%以上领域服务命名符合规范
- 不及格（<60分）：低于70%领域服务命名符合规范

**检查项**：
- [ ] 使用"聚合名 + Domain"格式（6分）：MembershipDomain、CouponDomain、PaymentDomain
- [ ] 不与 Application 层混淆（3分）：不使用 XxxService 命名
- [ ] 不使用中文（2分）：不使用中文命名

**命名规范**：
- ✅ 好的服务命名：MembershipDomain、CouponDomain、PaymentDomain
- ❌ 差的服务命名：MembershipService（与 Application 层混淆）、MembershipDomainService（繁琐，不够简洁）、MembershipServiceImpl（与领域服务混淆）、点券服务（中文，不符合代码规范）

**扣分项**：
- 命名不规范：服务命名不符合规范扣 3 分/个
- 与 Application 层混淆扣 3 分/个
- 使用中文扣 2 分/个

---

## 三、领域服务职责（20 分）

### 3.1 跨聚合协调（7 分）

**满分**：7 分

**评分标准**：
- 优秀（90-100分）：所有跨聚合协调都在领域服务中
- 良好（80-89分）：90%以上跨聚合协调在领域服务中
- 及格（60-79分）：70%以上跨聚合协调在领域服务中
- 不及格（<60分）：低于70%跨聚合协调在领域服务中

**检查项**：
- [ ] 跨聚合协调在领域服务（7分）：跨聚合协调放在领域服务中

**示例**：
```typescript
class OrderDomain {
  fulfillOrder(order: Order): void {
    // 协调多个聚合
    order.confirm()
    this.inventory.allocate(order.items)
    this.shipping.prepare(order.shippingAddress)
  }
}
```

**扣分项**：
- 跨聚合协调不在领域服务：扣 4 分/处

---

### 3.2 复杂计算（7 分）

**满分**：7 分

**评分标准**：
- 优秀（90-100分）：所有复杂计算都在领域服务中
- 良好（80-89分）：90%以上复杂计算在领域服务中
- 及格（60-79分）：70%以上复杂计算在领域服务中
- 不及格（<60分）：低于70%复杂计算在领域服务中

**检查项**：
- [ ] 复杂计算在领域服务（7分）：复杂计算逻辑放在领域服务中

**示例**：
```typescript
class PricingDomain {
  calculateDiscount(
    order: Order,
    user: User,
    currentDate: Date
  ): Money {
    let discount = Money.ZERO

    // 会员折扣
    if (user.hasMembership()) {
      discount = discount.add(user.membership.getDiscount())
    }

    // 时令折扣
    if (currentDate.isHoliday()) {
      discount = discount.add(order.total.multiply(0.1))
    }

    return discount
  }
}
```

**扣分项**：
- 复杂计算不在领域服务：扣 4 分/处

---

### 3.3 值对象创建（6 分）

**满分**：6 分

**评分标准**：
- 优秀（90-100分）：所有复杂的值对象创建都在领域服务中
- 良好（80-89分）：90%以上复杂值对象创建在领域服务中
- 及格（60-79分）：70%以上复杂值对象创建在领域服务中
- 不及格（<60分）：低于70%复杂值对象创建在领域服务中

**检查项**：
- [ ] 复杂值对象创建在领域服务（6分）：复杂的值对象创建逻辑放在领域服务中

**示例**：
```typescript
class MoneyFactory {
  createFromExternal(
    amountInCents: number,
    currencyCode: string
  ): Money {
    return new Money(
      BigInt(amountInCents),
      this.validateCurrency(currencyCode)
    )
  }
}
```

**扣分项**：
- 复杂值对象创建不在领域服务：扣 3 分/处

---

## 四、与聚合根协作（15 分）

### 4.1 调用聚合根行为（8 分）

**满分**：8 分

**评分标准**：
- 优秀（90-100分）：所有领域服务都通过调用聚合根行为来实现逻辑
- 良好（80-89分）：90%以上领域服务调用聚合根行为
- 及格（60-79分）：70%以上领域服务调用聚合根行为
- 不及格（<60分）：低于70%领域服务调用聚合根行为

**检查项**：
- [ ] 调用聚合根行为（5分）：领域服务通过调用聚合根行为来实现逻辑
- [ ] 不直接操作属性（3分）：不直接操作聚合根属性

**示例**：
```typescript
// ✅ 正确：领域服务调用聚合根行为
class MembershipDomain {
  upgradeMembership(membership: Membership, newLevel: MembershipLevel): void {
    // 业务验证
    if (!this.canUpgrade(membership, newLevel)) {
      throw new Error("Cannot upgrade membership")
    }
    // 调用聚合根行为
    membership.upgrade(newLevel)
  }
}

// ❌ 错误：直接操作聚合根属性
class MembershipDomain {
  upgradeMembership(membership: Membership, newLevel: MembershipLevel): void {
    membership.level = newLevel  // 直接修改属性
  }
}
```

**扣分项**：
- 直接操作属性：直接操作聚合根属性扣 4 分/处

---

### 4.2 事务边界（7 分）

**满分**：7 分

**评分标准**：
- 优秀（90-100分）：所有领域服务都不管理事务
- 良好（80-89分）：90%以上领域服务不管理事务
- 及格（60-79分）：70%以上领域服务不管理事务
- 不及格（<60分）：低于70%领域服务不管理事务

**检查项**：
- [ ] 领域服务不管理事务（5分）：领域服务不管理事务
- [ ] 事务管理在应用层（2分）：事务管理在应用层

**示例**：
```typescript
// ✅ 正确：领域服务只负责业务逻辑
class MembershipDomain {
  upgradeMembership(membership: Membership, newLevel: MembershipLevel): void {
    membership.upgrade(newLevel)
  }
}

// ❌ 错误：领域服务管理事务
class MembershipDomain {
  @Transactional
  upgradeMembership(membership: Membership, newLevel: MembershipLevel): void {
    membership.upgrade(newLevel)
    this.repo.save(membership)  // 不应该在领域服务中
  }
}
```

**扣分项**：
- 领域服务管理事务：领域服务包含事务管理扣 5 分/处

---

## 快速评分表

| 检查项 | 分值 | 得分 | 备注 |
|--------|------|------|------|
| **领域服务识别** | | | |
| 涉及多个聚合 | 4 | __ | 识别标准 |
| 不属于特定实体 | 3 | __ | 识别标准 |
| 复杂计算 | 3 | __ | 识别标准 |
| 优先在聚合根 | 4 | __ | vs聚合根行为 |
| 范围区分 | 3 | __ | vs聚合根行为 |
| 状态修改 | 3 | __ | vs聚合根行为 |
| 示例正确 | 2 | __ | vs聚合根行为 |
| 决策树使用 | 8 | __ | 识别决策树 |
| **领域服务设计** | | | |
| 不持有聚合引用 | 6 | __ | 无状态原则 |
| 方法接收参数 | 4 | __ | 无状态原则 |
| 无实例变量 | 2 | __ | 无状态原则 |
| 协调多个聚合 | 6 | __ | 协调原则 |
| 通过聚合根行为 | 6 | __ | 协调原则 |
| 命名格式 | 6 | __ | "聚合名+Domain" |
| 不混淆Application | 3 | __ | 命名规范 |
| 不使用中文 | 2 | __ | 命名规范 |
| **领域服务职责** | | | |
| 跨聚合协调 | 7 | __ | 协调服务 |
| 复杂计算 | 7 | __ | 计算服务 |
| 值对象创建 | 6 | __ | 转换服务 |
| **与聚合根协作** | | | |
| 调用聚合根行为 | 5 | __ | 协作原则 |
| 不直接操作属性 | 3 | __ | 协作原则 |
| 领域服务不管理事务 | 5 | __ | 事务边界 |
| 事务管理在应用层 | 2 | __ | 事务边界 |
| **总计** | 100 | __ | |

---

## 及格标准

- **章节及格线**：60 分
- **优秀线**：80 分
- **核心项必须通过**：
  - 识别标准 ≥ 7 分
  - 无状态原则 ≥ 8 分
  - 协调原则 ≥ 8 分
  - 命名规范 ≥ 7 分
  - 调用聚合根行为 ≥ 4 分

---

## 评分示例

### 优秀示例（93 分）

**场景**：会员领域服务设计

**评分过程**：
1. 领域服务识别：28/30 分
   - 识别标准：10/10 分（所有服务都通过识别标准）
   - vs聚合根行为：11/12 分（正确区分，扣1分因为有一个示例不够清晰）
   - 识别决策树：7/8 分（使用决策树，扣1分因为有一个服务未使用决策树验证）

2. 领域服务设计：33/35 分
   - 无状态原则：12/12 分（所有服务都是无状态的）
   - 协调原则：11/12 分（正确协调，扣1分因为有一处协调逻辑描述不够清晰）
   - 命名规范：10/11 分（命名符合规范，扣1分因为有一个服务命名略长）

3. 领域服务职责：19/20 分
   - 跨聚合协调：7/7 分（所有跨聚合协调都在领域服务中）
   - 复杂计算：7/7 分（所有复杂计算都在领域服务中）
   - 值对象创建：5/6 分（基本都在领域服务中，扣1分因为有一个简单值对象创建也放在了领域服务）

4. 与聚合根协作：13/15 分
   - 调用聚合根行为：7/8 分（基本都调用聚合根行为，扣1分因为有一处直接操作了属性）
   - 事务边界：6/7 分（领域服务不管理事务，扣1分因为有一处事务说明不够清晰）

**总分**：93/100 分（优秀）

**改进建议**：
1. 完善示例说明
2. 所有服务都使用决策树验证
3. 完善协调逻辑描述
4. 优化服务命名长度
5. 简单值对象创建不必放在领域服务
6. 避免直接操作属性
7. 完善事务说明

---

## 原则追溯

本评分标准基于以下原则：
- domain-service.md 1.1-1.3：领域服务识别原则
- domain-service.md 2.1-2.3：领域服务设计原则
- domain-service.md 3.1-3.3：领域服务职责原则
- domain-service.md 4.1-4.2：领域服务与聚合根协作原则
- domain-service.md 5.1-5.3：领域服务类型

---

## 检查清单对应

本评分标准与 chapter-03-checklist.md 对应：
- 领域服务识别 → 检查清单第 1 节
- 领域服务设计 → 检查清单第 2 节
- 领域服务职责 → 检查清单第 3 节
- 与聚合根协作 → 检查清单第 4 节
- 领域服务类型 → 检查清单第 5 节
