# 第三章：领域服务设计

## 章节目标

完成领域服务设计，包括：
1. **领域服务判断**：判断哪些逻辑应该设计为领域服务
2. **服务列表**：列出所有领域服务
3. **服务详细设计**：设计每个领域服务的方法、职责、约束

---

## 输入来源

从 PRD 和第二章中提取以下信息：

| 来源 | 提取内容 | 转化目标 |
|------|---------|---------|
| PRD 业务流程 | 跨聚合的业务逻辑 | 领域服务候选 |
| 第二章 聚合设计 | 聚合边界 | 服务归属判断 |
| PRD 复杂计算 | 复杂算法 | 领域服务 |

---

## 生成步骤

### Step 1：领域服务判断

**目标**：判断哪些逻辑应该设计为领域服务。

#### 1.1 领域服务判断标准

**判断标准**：满足以下任一条件 → 领域服务候选

| 标准 | 说明 | 示例 |
|------|------|------|
| **涉及多个聚合** | 逻辑需要访问多个聚合 | 计算会员总收益（跨会员和点券聚合） |
| **不属于特定实体** | 逻辑无法自然归属到某个实体 | 货币转换服务 |
| **复杂计算** | 复杂算法或计算 | 价格计算引擎 |

#### 1.2 领域服务 vs 聚合根行为

| 维度 | 聚合根行为 | 领域服务 |
|------|-----------|---------|
| 范围 | 单个聚合内 | 跨聚合或无自然归属 |
| 状态修改 | 修改聚合状态 | 不修改聚合状态（或协调多个聚合） |
| 示例 | `order.addItem()` | `calculateDiscount(order, user)` |

#### 1.3 领域服务识别决策树

```
这个逻辑是领域服务吗？
│
├─ 涉及多个聚合吗？
│   ├─ 是 → 领域服务
│   └─ 否 → 继续
│
├─ 属于某个实体吗？
│   ├─ 是 → 实体行为
│   └─ 否 → 继续
│
└─ 是复杂计算吗？
    ├─ 是 → 领域服务
    └─ 否 → 可能是值对象或简单函数
```

---

### Step 2：领域服务列表

**目标**：列出所有领域服务。

#### 2.1 服务列表表格

| 服务名称 | 职责 | 涉及聚合 | 优先级 |
|---------|------|---------|--------|
| {服务1} | {职责描述} | {聚合A}, {聚合B} | P0 |
| {服务2} | {职责描述} | {聚合C} | P1 |

#### 2.2 服务命名规范

```
格式：{聚合名} + Domain

示例：
✅ 好的服务命名
- MembershipDomain
- CouponDomain
- PaymentDomain

❌ 差的服务命名
- MembershipService（与 Application 层混淆）
- MembershipDomainService（繁琐，不够简洁）
- Discount（缺少聚合名）
- 点券服务（中文，不符合代码规范）
```

---

### Step 3：服务详细设计

**目标**：设计每个领域服务的方法、职责、约束。

#### 3.1 方法签名

```typescript
{方法名}(params: { {参数1}: {类型1}, {参数2}: {类型2} }): {返回类型}
```

#### 3.2 职责描述

{简要描述服务的核心职责}

#### 3.3 约束定义

| 约束ID | 类型 | 描述 | 伪代码 | 执行时机 |
|-------|------|------|-------|---------|
| BIZ-{服务缩写}-01 | 业务规则 | {约束描述} | `ASSERT {条件表达式}` | 执行时 |

#### 3.4 用例设计

**Case-{服务缩写}-N1: {正向场景}**

| Given | When | Then | 验证约束 |
|-------|------|------|---------|
| {前置条件} | {方法名}({参数}={值}) | {结果描述} | BIZ-{服务缩写}-01 ✓ |

**Case-{服务缩写}-B1: {约束违反场景}**

| Given | When | Then | 违反约束 |
|-------|------|------|---------|
| {前置条件} | {方法名}({参数}={非法值}) | 拒绝，"{错误信息}" | BIZ-{服务缩写}-01 ✗ |

**Case-{服务缩写}-E1: 边界场景**

| Given | When | Then | 验证约束 |
|-------|------|------|---------|
| {边界条件} | {方法名}({参数}={边界值}) | {结果描述} | BIZ-{服务缩写}-01 ✓ |

---

## 输出格式

### 1. 领域服务列表

| 服务名称 | 职责 | 涉及聚合 | 优先级 |
|---------|------|---------|--------|
| {服务1} | {职责描述} | {聚合A}, {聚合B} | P0 |
| {服务2} | {职责描述} | {聚合C} | P1 |

---

### 2. 单个领域服务详细设计

#### 2.1 服务：{服务名称}

**基本信息**

| 字段 | 值 |
|------|-----|
| 服务名称 | {服务名称} |
| 职责 | {职责描述} |
| 涉及聚合 | {聚合A}, {聚合B} |
| 优先级 | P0 |

**方法签名**

```typescript
{方法名}(params: { {参数1}: {类型1}, {参数2}: {类型2} }): {返回类型}
```

**职责描述**

{详细描述服务的核心职责}

**约束定义**

| 约束ID | 类型 | 描述 | 伪代码 | 执行时机 |
|-------|------|------|-------|---------|
| BIZ-{服务缩写}-01 | 业务规则 | {约束描述} | `ASSERT {条件表达式}` | 执行时 |

**用例设计**

**Case-{服务缩写}-N1: {正向场景}**

| Given | When | Then | 验证约束 |
|-------|------|------|---------|
| {前置条件} | {方法名}({参数}={值}) | {结果描述} | BIZ-{服务缩写}-01 ✓ |

**Case-{服务缩写}-B1: {约束违反场景}**

| Given | When | Then | 违反约束 |
|-------|------|------|---------|
| {前置条件} | {方法名}({参数}={非法值}) | 拒绝，"{错误信息}" | BIZ-{服务缩写}-01 ✗ |

**Case-{服务缩写}-E1: 边界场景**

| Given | When | Then | 验证约束 |
|-------|------|------|---------|
| {边界条件} | {方法名}({参数}={边界值}) | {结果描述} | BIZ-{服务缩写}-01 ✓ |

---

## 质量检查

完成本章后，使用以下检查清单自检：

### 检查清单

- [ ] 所有领域服务已识别
- [ ] 服务命名符合规范
- [ ] 服务职责清晰
- [ ] 每个服务都有方法签名
- [ ] 每个服务都有约束定义
- [ ] 每个服务都有用例设计
- [ ] 服务不包含实体的行为
- [ ] 服务不修改聚合状态（或协调多个聚合）


---

## 常见问题

### Q1: 领域服务判断标准是什么？

**判断标准**：满足以下任一条件 → 领域服务候选

| 标准 | 说明 | 示例 |
|------|------|------|
| **涉及多个聚合** | 逻辑需要访问多个聚合 | 计算会员总收益 |
| **不属于特定实体** | 逻辑无法自然归属到某个实体 | 货币转换服务 |
| **复杂计算** | 复杂算法或计算 | 价格计算引擎 |

### Q2: 领域服务和聚合根行为的区别？

| 维度 | 聚合根行为 | 领域服务 |
|------|-----------|---------|
| 范围 | 单个聚合内 | 跨聚合或无自然归属 |
| 状态修改 | 修改聚合状态 | 不修改聚合状态（或协调多个聚合） |
| 示例 | `order.addItem()` | `calculateDiscount(order, user)` |

### Q3: 领域服务可以修改聚合状态吗？

**原则**：
- **无状态服务**：理想情况下，领域服务不修改聚合状态
- **协调服务**：如果需要协调多个聚合，通过调用聚合根的行为来修改状态

```typescript
// ✅ 正确：领域服务协调，不直接修改状态
class TransferPointsService {
  transfer(from: Membership, to: Membership, amount: number): void {
    from.deductPoints(amount)  // 调用聚合根行为
    to.addPoints(amount)        // 调用聚合根行为
  }
}

// ❌ 错误：领域服务直接修改状态
class TransferPointsService {
  transfer(from: Membership, to: Membership, amount: number): void {
    from.points -= amount  // 直接修改状态
    to.points += amount
  }
}
```
