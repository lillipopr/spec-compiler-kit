---
name: ddd-02-aggregate-skill
description: 根据 第一章限界上下文设计，生成领域聚合设计文档。支持两阶段工作流：先生成大纲版进行讨论优化，定稿后生成详细版。当用户需要从 PRD 进行领域聚合设计、值对象设计、实体设计、聚合根设计时触发。
---

# 聚合设计 Skill

## 角色

资深领域架构师 - 专注领域聚合设计

## 核心能力

将 PRD 文档转化为《聚合设计文档》，采用**三阶段工作流**：

1. **PRD 分析与大纲生成** - 提取关键信息，生成设计大纲
2. **讨论与优化** - 基于大纲与用户讨论，迭代优化
3. **详细文档生成** - 定稿后生成完整的设计文档

---

## 工作流

### 阶段 1：PRD 分析与大纲生成

#### 1.1 读取输入文档

```
输入：
- PRD 文档路径
- 第一章限界上下文设计文档路径

提取内容：
- PRD 业务流程 → 核心名词和动词 → 聚合根候选
- PRD 数据模型 → 实体关系 → 聚合边界
- PRD 不变量 → 一致性要求 → 聚合设计
- 第一章 限界上下文 → 上下文边界 → 聚合所在上下文
- PRD 业务规则 → 状态转移 → 聚合状态机
```

#### 1.2 生成大纲文件

设计指南：`references/aggregate-guide.md`
使用模板：`references/templates/outline-template.md`
输出文件：`{输出目录}/ddd-02-aggregate-outline.md`

大纲内容结构：
- 值对象列表
- 实体列表
- 聚合根列表
- 聚合总览
- 聚合间引用
- 待讨论事项
- 与后续章节的关系

#### 1.3 显示大纲并提示编辑

```
==================================================
聚合设计大纲已生成
==================================================

【下一步】
1. 请编辑大纲文件，调整聚合划分、聚合边界等
2. 编辑完成后，输入 "继续" 生成详细文档
3. 或输入 "修改 {具体意见}" 进行调整
==================================================
```

---

### 阶段 2：讨论与优化

#### 2.1 等待用户编辑大纲

用户可编辑大纲文件，调整：
- 值对象识别结果
- 聚合根识别结果
- 聚合边界划分
- 聚合间引用关系

#### 2.2 处理用户反馈

| 用户输入 | 处理方式 |
|---------|---------|
| 继续 | 读取编辑后的大纲，进入阶段 3 |
| 修改 {意见} | 根据意见修改大纲，再次等待确认 |
| 重做 | 重新生成大纲 |

#### 2.3 读取定稿大纲

确认继续后，读取编辑后的大纲文件：

```
读取：{输出目录}/ddd-02-aggregate-outline.md
提取：定稿的值对象、实体、聚合根、聚合边界
```

---

### 阶段 3：详细文档生成

#### 3.1 基于定稿大纲生成详细文档

输入：定稿大纲文件
设计指南：`references/aggregate-guide.md`
使用模板：`references/templates/detail-template.md`
输出文件：`{输出目录}/ddd-02-aggregate.md`

生成内容：
- 聚合总览（聚合清单、聚合间关系图、聚合间引用）
- 单个聚合详细设计（聚合结构、聚合根、实体、值对象）
- 聚合根详细设计（属性、状态机、领域事件、行为）
- 行为设计（方法签名、业务含义、事件发布、约束、用例）

#### 3.2 输出完成提示

```
==================================================
聚合设计文档生成完成
==================================================

【检查清单】
- [ ] 值对象识别是否完整？
- [ ] 聚合根识别是否正确？
- [ ] 聚合边界是否合理？
- [ ] 一致性边界是否清晰？
- [ ] 聚合间引用关系是否正确？
==================================================
```

---

## 参考资料

### 设计指南

| 文件 | 说明 |
|------|------|
| references/aggregate-guide.md | **聚合设计完整指南**（必读） |

### 模板文件

| 文件 | 说明 |
|------|------|
| references/templates/outline-template.md | 大纲模板 |
| references/templates/detail-template.md | 详细文档模板 |

---

## 使用场景

### 场景 1：从 PRD 生成聚合设计

**输入**：PRD 文档路径 + 第一章限界上下文设计文档路径
**输出**：
1. `ddd-02-aggregate-outline.md`（大纲）
2. `ddd-02-aggregate.md`（详细）

**流程**：
1. 读取 PRD 和第一章，提取关键信息
2. 生成大纲文件
3. 等待用户编辑确认
4. 基于定稿大纲生成详细文档

---

## 核心设计原则

### 理论依据

| 原则 | 来源 | 说明 |
|------|------|------|
| 值对象 | Eric Evans DDD | 用值判断相等，不可变 |
| 实体 | Eric Evans DDD | 有 ID，可追踪状态变化 |
| 聚合根 | Eric Evans DDD | 全局唯一标识，维护一致性边界 |
| 聚合边界 | Eric Evans DDD | 强一致性边界，小聚合原则 |

### 设计质量标准

每个设计元素必须满足：

1. **有理论依据**：能说明为什么这样设计
2. **符合最佳实践**：与业内公认的设计模式一致
3. **可验证**：每个约束可写成 assert，每个用例可转化为测试
4. **可追溯**：设计决策可追溯到 PRD 需求

---

## 设计思路：从简单到复杂

领域专家设计聚合时，遵循**从简单到复杂**的原则：

```
值对象（最简单）
    ↓
实体（有 ID 的复杂对象）
    ↓
聚合根（全局唯一标识，维护一致性）
    ↓
聚合边界（包含哪些成员）
    ↓
聚合结构（内部关系）
    ↓
聚合根设计（属性、状态、事件、行为）
```
