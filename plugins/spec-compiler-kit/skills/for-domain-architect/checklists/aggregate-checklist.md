---
description: 聚合设计检查清单
---

# 聚合设计检查清单

## 概述

本检查清单用于验证聚合设计的正确性和完整性。

## 检查清单

### 1. 聚合根识别

- [ ] 聚合根有全局唯一标识
- [ ] 聚合根有独立生命周期
- [ ] 聚合根维护一致性边界
- [ ] 聚合根是唯一入口
- [ ] 聚合根有专门仓储

### 2. 聚合边界

- [ ] 聚合大小合理（1-7 个实体）
- [ ] 聚合深度合理（1-3 层）
- [ ] 聚合内强一致
- [ ] 聚合间最终一致
- [ ] 一个事务只修改一个聚合

### 3. 聚合间引用

- [ ] 聚合间引用只使用 ID
- [ ] 不存储对象引用
- [ ] 不加载其他聚合
- [ ] 通过领域事件协作
- [ ] 考虑了并发冲突

### 4. 不变量

- [ ] 不变量已识别
- [ ] 不变量在聚合内强制执行
- [ ] 不变量验证在构造时
- [ ] 不变量验证在操作时
- [ ] 不变量文档化

### 5. 行为设计

- [ ] 聚合根方法封装状态变更
- [ ] 实体行为正确归属
- [ ] 领域服务正确识别
- [ ] 应用服务正确编排
- [ ] 行为命名清晰

### 6. 领域事件

- [ ] 状态变更发布事件
- [ ] 事件命名符合规范（过去式）
- [ ] 事件携带数据最小化
- [ ] 事件在聚合内记录
- [ ] 事件在保存后发布

### 7. 仓储接口

- [ ] 仓储针对聚合根
- [ ] 仓储方法有业务语义
- [ ] 仓储隐藏持久化细节
- [ ] 仓储接口完整
- [ ] 考虑了查询优化

## 验证问题

### 聚合根验证

```
Q1: 这个对象是聚合根吗？
A1: 有全局唯一标识？ ✅/❌
A2: 有独立生命周期？ ✅/❌
A3: 维护一致性边界？ ✅/❌

Q2: 为什么它是聚合根？
A: {原因}

Q3: 聚合根的职责是什么？
A: {职责}
```

### 边界验证

```
Q1: 这些对象需要在同一个聚合中吗？
A1: 需要一起修改？ ✅/❌
A2: 需要强一致？ ✅/❌
A3: 删除聚合根时需要删除？ ✅/❌

Q2: 聚合大小合理吗？
A: 实体数量：{数量}
   深度：{深度}
   是否需要拆分？ ✅/❌

Q3: 一个事务能完成聚合的修改吗？
A: ✅/❌
```

### 引用验证

```
Q1: 为什么引用这个聚合？
A: {原因}

Q2: 引用方式正确吗？
A: 只存储 ID？ ✅/❌

Q3: 如何协作？
A: 同步调用 / 领域事件 / 领域服务
```

## 常见问题

### 问题 1: 聚合太大

**症状**：
- 聚合包含 8+ 个实体
- 聚合深度 > 3 层
- 一个事务无法完成修改

**解决方案**：
1. 分析是否所有对象都需要一起修改
2. 考虑拆分为多个聚合
3. 通过 ID 引用其他聚合

### 问题 2: 聚合间存储对象引用

**症状**：
- 聚合存储其他聚合的对象
- 加载时级联加载

**解决方案**：
1. 只存储 ID
2. 通过仓储按需加载
3. 使用领域事件异步协作

### 问题 3: 不变量未封装

**症状**：
- 不变量验证在服务层
- 不变量验证在数据库

**解决方案**：
1. 将不变量验证移到聚合内
2. 在构造时验证
3. 在操作时验证

## 通过标准

- [ ] 所有关键检查项都通过
- [ ] 没有阻塞性问题
- [ ] 聚合测试覆盖完整
- [ ] 并发场景已考虑

## 测试清单

### 单元测试

- [ ] 聚合根创建测试
- [ ] 聚合根行为测试
- [ ] 不变量验证测试
- [ ] 领域事件发布测试
- [ ] 错误场景测试

### 集成测试

- [ ] 仓储保存测试
- [ ] 仓储查询测试
- [ ] 并发冲突测试
- [ ] 事务一致性测试
