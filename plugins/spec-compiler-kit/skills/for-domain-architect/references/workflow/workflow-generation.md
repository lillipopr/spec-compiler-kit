# 生成流程详解

> **目标**：从 PRD 到领域设计文档的标准化生成流程

---

## 流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          生成流程                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  输入：PRD 文档                                                           │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 1：PRD 分析                                                │    │
│  │   - 识别功能概述                                                │    │
│  │   - 识别核心实体                                                │    │
│  │   - 识别业务流程                                                │    │
│  │   - 识别外部接口需求                                            │    │
│  │   - 识别异步处理需求                                            │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 2：第一章 - 限界上下文设计                                   │    │
│  │   ↓ 生成内容                                                      │    │
│  │   ↓ 自检评分 ≥60?                                                 │    │
│  │   ├─ 是 → 继续                                                   │    │
│  │   └─ 否 → 重生成                                                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 3：第二章 - 聚合设计                                         │    │
│  │   ↓ 生成内容                                                      │    │
│  │   ↓ 自检评分 ≥60?                                                 │    │
│  │   ├─ 是 → 继续                                                   │    │
│  │   └─ 否 → 重生成                                                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 4：第三章 - 领域服务设计                                      │    │
│  │   ↓ 生成内容                                                      │    │
│  │   ↓ 自检评分 ≥60?                                                 │    │
│  │   ├─ 是 → 继续                                                   │    │
│  │   └─ 否 → 重生成                                                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 5：第四章 - 应用层设计                                       │    │
│  │   ↓ 生成内容                                                      │    │
│  │   ↓ 自检评分 ≥60?                                                 │    │
│  │   ├─ 是 → 继续                                                   │    │
│  │   └─ 否 → 重生成                                                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 6：第五章 - 领域事件                                         │    │
│  │   ↓ 生成内容                                                      │    │
│  │   ↓ 自检评分 ≥60?                                                 │    │
│  │   ├─ 是 → 继续                                                   │    │
│  │   └─ 否 → 重生成                                                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 7：第六章 - 入口层设计                                       │    │
│  │   ↓ 生成内容                                                      │    │
│  │   ↓ 自检评分 ≥60?                                                 │    │
│  │   ├─ 是 → 继续                                                   │    │
│  │   └─ 否 → 重生成                                                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ Step 8：组装文档                                                 │    │
│  │   - 使用模板组装各章节                                           │    │
│  │   - 生成 Markdown 文档                                           │    │
│  │   - 验证文档完整性                                                │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  输出：领域设计文档（草稿）                                                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Step 1：PRD 分析

### 分析目标

从 PRD 中提取生成领域设计文档所需的信息。

### 分析内容

| 分析项 | 提取内容 | 转化目标 | 章节 |
|-------|---------|---------|------|
| **功能概述** | 功能描述、业务背景 | 业务能力分析 | 第一章 |
| **核心实体** | 业务对象 | 聚合根识别 | 第二章 |
| **业务流程** | 状态转移、操作步骤 | 聚合根行为、用例 | 第二、四章 |
| **外部接口** | API 需求 | 应用服务、Controller | 第四、六章 |
| **异步处理** | 消息通知 | 领域事件 | 第五章 |
| **定时任务** | 后台任务 | Task 设计 | 第六章 |

### 分析输出

**PRD 分析摘要模板**：

```markdown
## PRD 分析摘要

### 功能概述
{功能描述}

### 核心实体
{实体列表}

### 业务流程
{流程列表}

### 外部接口
{接口需求}

### 异步处理
{事件需求}

### 定时任务
{任务需求}
```

---

## Step 2-7：章节生成

### 生成模板

每个章节的生成流程一致：

```
┌─────────────────────────────────────────┐
│ 章节生成                                 │
├─────────────────────────────────────────┤
│ 1. 读取章节指令                          │
│ 2. 读取对应原则                          │
│ 3. 提取 PRD 信息                         │
│ 4. 生成章节内容                          │
│ 5. 自检评分                              │
│    ├─ ≥60 → 通过                         │
│    └─ <60 → 重生成                       │
└─────────────────────────────────────────┘
```

### 第一章：限界上下文设计

**指令文件**：`chapters/chapter-01-bounded-context.md`
**原则文件**：`principles/bounded-context.md`

**生成内容**：
1. 业务能力分析
   - 业务能力树
   - 能力分级
   - 能力与团队对齐
2. 限界上下文划分
   - 上下文识别
   - 上下文类型
3. 上下文映射
   - 上下文关系图
   - 集成模式定义
   - 防腐层设计

**自检问题**：
- [ ] 业务能力树是否完整？
- [ ] 上下文划分是否合理？
- [ ] 上下文映射是否清晰？
- [ ] 防腐层是否必要？

**评分标准**：使用 `scoring/01-strategic-scoring.md`

### 第二章：聚合设计

**指令文件**：`chapters/chapter-02-aggregate.md`
**原则文件**：`principles/aggregate.md`

**生成内容**：
1. 聚合总览
   - 聚合清单
   - 聚合间关系图
2. 单个聚合详细设计
   - 聚合结构
   - 聚合根设计
   - 行为设计
   - 实体设计
   - 值对象设计

**自检问题**：
- [ ] 聚合根识别是否正确？
- [ ] 聚合边界是否清晰？
- [ ] 实体与值对象是否区分？
- [ ] 行为设计是否完整？
- [ ] 约束定义是否清晰？

**评分标准**：使用 `scoring/02-tactical-scoring.md`

### 第三章：领域服务设计

**指令文件**：`chapters/chapter-03-domain-service.md`
**原则文件**：`principles/domain-service.md`

**生成内容**：
1. 领域服务判断
2. 服务列表
3. 单个领域服务详细设计
   - 方法签名
   - 职责描述
   - 约束定义
   - 用例设计

**自检问题**：
- [ ] 服务识别是否完整？
- [ ] 服务命名是否符合规范？
- [ ] 服务职责是否清晰？
- [ ] 约束定义是否完整？

**评分标准**：使用 `scoring/02-tactical-scoring.md`

### 第四章：应用层设计

**指令文件**：`chapters/chapter-04-application.md`
**原则文件**：`principles/application.md`

**生成内容**：
1. 应用服务列表
2. 用户行为列表
3. 系统行为列表
4. 单个应用服务详细设计
   - 方法签名
   - 职责描述
   - 约束定义
   - 用例设计

**自检问题**：
- [ ] 用户行为与系统行为是否区分？
- [ ] 应用服务命名是否符合规范？
- [ ] 用例设计是否完整？
- [ ] 约束定义是否清晰？

**评分标准**：使用 `scoring/04-use-case-scoring.md`

### 第五章：领域事件

**指令文件**：`chapters/chapter-05-domain-event.md`
**原则文件**：`principles/domain-event.md`

**生成内容**：
1. 事件列表
2. 单个事件详细设计
   - 触发条件
   - 携带数据
   - 订阅方

**自检问题**：
- [ ] 事件识别是否完整？
- [ ] 事件命名是否符合规范？
- [ ] 触发条件是否清晰？
- [ ] 携带数据是否必要？
- [ ] 订阅方是否完整？

**评分标准**：使用 `scoring/02-tactical-scoring.md`

### 第六章：入口层设计

**指令文件**：`chapters/chapter-06-starter.md`
**原则文件**：`principles/starter.md`

**生成内容**：
1. Controller 层
   - Controller 总览
   - Controller 详细设计
   - 接口设计
2. MQ 层
   - MQ 总览
   - 消费者详细设计
3. Task 层
   - Task 总览
   - 任务详细设计

**自检问题**：
- [ ] 接口路径是否符合规范？
- [ ] 参数命名是否符合规范（XxxParam）？
- [ ] 是否使用对象类型（非原始类型）？
- [ ] 消费者幂等性是否保证？
- [ ] 定时任务是否有分布式锁？

**评分标准**：使用 `scoring/04-use-case-scoring.md`

---

## Step 8：组装文档

### 组装流程

```
┌─────────────────────────────────────────┐
│ 文档组装                                 │
├─────────────────────────────────────────┤
│ 1. 读取模板                              │
│ 2. 填充章节内容                          │
│ 3. 生成目录                              │
│ 4. 生成引用                              │
│ 5. 验证完整性                            │
└─────────────────────────────────────────┘
```

### 模板文件

`assets/templates/domain-design-template.md`

### 验证检查

- [ ] 所有章节已填充
- [ ] 目录已生成
- [ ] 引用关系正确
- [ ] Markdown 格式正确
- [ ] 无遗漏内容

---

## 生成质量控制

### 质量关卡

| 关卡 | 位置 | 标准 | 处理 |
|------|------|------|------|
| 关卡1 | 每章生成后 | ≥60 分 | 重生成 |
| 关卡2 | 文档组装后 | 所有章节完成 | 返回 |

### 重生成策略

**触发条件**：章节评分 <60 分

**重生成步骤**：
1. 分析失败原因
2. 调整生成策略
3. 重新生成内容
4. 重新评分
5. 最多重试 3 次

**失败处理**：
- 3 次重生成仍 <60 分
- 记录问题
- 人工介入
- 调整后继续

---

## 生成优化策略

### 并行生成

**可并行的章节**：
- 第三章（领域服务）和第五章（领域事件）可并行生成
- 都基于第二章（聚合设计）的结果

**并行策略**：
1. 完成第二章后
2. 同时启动第三章和第五章
3. 等待两者都完成
4. 继续第四章

### 智能缓存

**缓存内容**：
- PRD 分析结果
- 已生成的章节
- 评分结果

**缓存使用**：
- 重生成时使用缓存
- 避免重复分析
- 提高效率

---

## 生成输出

### 输出格式

Markdown 格式的领域设计文档

### 输出文件

`{功能名称}-领域设计文档.md`

### 输出结构

```markdown
# {功能名称} - 领域设计文档

## 第一章：限界上下文设计
{内容}

## 第二章：聚合设计
{内容}

## 第三章：领域服务设计
{内容}

## 第四章：应用层设计
{内容}

## 第五章：领域事件
{内容}

## 第六章：入口层设计
{内容}
```

---

## 支持文档

### 章节指令
- [第一章指令](../chapters/chapter-01-bounded-context.md)
- [第二章指令](../chapters/chapter-02-aggregate.md)
- [第三章指令](../chapters/chapter-03-domain-service.md)
- [第四章指令](../chapters/chapter-04-application.md)
- [第五章指令](../chapters/chapter-05-domain-event.md)
- [第六章指令](../chapters/chapter-06-starter.md)

### 设计原则
- [限界上下文原则](../principles/bounded-context.md)
- [聚合相关原则](../principles/aggregate.md)
- [领域服务原则](../principles/domain-service.md)
- [应用层原则](../principles/application.md)
- [领域事件原则](../principles/domain-event.md)
- [入口层原则](../principles/starter.md)

### 评分标准
- [战略设计评分](../scoring/01-strategic-scoring.md)
- [战术设计评分](../scoring/02-tactical-scoring.md)
- [约束评分](../scoring/03-constraint-scoring.md)
- [用例评分](../scoring/04-use-case-scoring.md)
