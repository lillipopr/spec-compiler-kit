# 领域架构师工作流

> **核心工作流**：PRD → 领域设计文档 → 评分 → Review → 修改 → 交付

---

## 工作流概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      领域架构师完整工作流                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 第一阶段：生成流程                                                │    │
│  │  PRD → 第一章 → 第二章 → 第三章 → 第四章 → 第五章 → 第六章         │    │
│  │  每章生成后自检评分，≥60 分通过，<60 分重生成                        │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 第二阶段：评估流程                                                │    │
│  │  章节评分 + 综合评分 → 总分 ≥90 分通过，<90 分需修改               │    │
│  │  生成评分报告，指出问题章节                                        │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 第三阶段：Review 流程                                             │    │
│  │  用户 Review → 提出修改意见                                        │    │
│  │  分析问题 → 定位章节 → 制定修改方案                                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │ 第四阶段：修改流程                                                │    │
│  │  增量修改问题章节 → 重新评分 → 返回评估流程                         │    │
│  │  支持多轮迭代，直到总分 ≥90 分                                     │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│    ↓                                                                     │
│  交付：《{功能名称} - 领域设计文档》                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 第一章节：生成流程

### 生成流程概览

```
输入：PRD 文档
  ↓
┌─────────────────────────────────────────────────────────────┐
│ 第一章：限界上下文设计                                        │
│   ↓ 生成 ↓ 自检评分 ≥60?                                       │
│ 第二章：聚合设计                                              │
│   ↓ 生成 ↓ 自检评分 ≥60?                                       │
│ 第三章：领域服务设计                                          │
│   ↓ 生成 ↓ 自检评分 ≥60?                                       │
│ 第四章：应用层设计                                            │
│   ↓ 生成 ↓ 自检评分 ≥60?                                       │
│ 第五章：领域事件                                              │
│   ↓ 生成 ↓ 自检评分 ≥60?                                       │
│ 第六章：入口层设计（Starter 层）                               │
│   ↓ 生成 ↓ 自检评分 ≥60?                                       │
└─────────────────────────────────────────────────────────────┘
  ↓
输出：领域设计文档（草稿）
```

### 生成步骤

#### Step 1：读取并分析 PRD

**输入**：PRD 文档路径

**分析内容**：
- 功能概述
- 核心实体
- 业务流程
- 外部接口需求
- 异步处理需求

**输出**：PRD 分析摘要

#### Step 2：按章节顺序生成

**参考指令**：`chapters/chapter-XX-{name}.md`

**生成顺序**：

| 章节 | 文件 | 及格线 | 参考原则 |
|------|------|--------|----------|
| 第一章 | chapter-01-bounded-context.md | 60分 | bounded-context.md |
| 第二章 | chapter-02-aggregate.md | 60分 | aggregate.md |
| 第三章 | chapter-03-domain-service.md | 60分 | domain-service.md |
| 第四章 | chapter-04-application.md | 60分 | application.md |
| 第五章 | chapter-05-domain-event.md | 60分 | domain-event.md |
| 第六章 | chapter-06-starter.md | 60分 | starter.md |

#### Step 3：每章生成后自检

**检查清单**：使用章节对应的检查清单

**评分标准**：使用 `references/scoring/` 中的评分标准

**自检问题**：
- 所有设计元素是否完整？
- 是否符合设计原则？
- 是否覆盖了 PRD 中的所有需求？
- 是否有矛盾或遗漏？

**评分结果**：
- ≥60 分 → 继续下一章
- <60 分 → 重生成本章

#### Step 4：生成完整文档

**模板**：`assets/templates/domain-design-template.md`

**输出格式**：Markdown 格式的领域设计文档

---

## 第二章节：评估流程

### 评估流程概览

```
输入：领域设计文档（草稿）
  ↓
┌─────────────────────────────────────────────────────────────┐
│ 章节评分                                                     │
│   第一章：战略设计评分（权重 15%）                           │
│   第二章：聚合设计评分（权重 25%）                           │
│   第三章：领域服务评分（权重 10%）                           │
│   第四章：应用层评分（权重 15%）                             │
│   第五章：领域事件评分（权重 10%）                           │
│   第六章：入口层评分（权重 10%）                             │
│   设计一致性（权重 15%）                                     │
└─────────────────────────────────────────────────────────────┘
  ↓
总分 = Σ(章节分数 × 权重)
  ↓
总分 ≥ 90?
  ├─ 是 → 通过，进入 Review
  └─ 否 → 需修改，返回修改流程
```

### 章节评分标准

| 章节 | 评分维度 | 满分 | 及格线 |
|------|---------|------|--------|
| 第一章 | 业务能力分析、上下文划分、上下文映射 | 100 | 60 |
| 第二章 | 聚合识别、聚合根设计、实体值对象 | 100 | 60 |
| 第三章 | 服务识别、服务设计、约束定义 | 100 | 60 |
| 第四章 | 应用服务、用户行为、系统行为 | 100 | 60 |
| 第五章 | 事件识别、事件设计、订阅方 | 100 | 60 |
| 第六章 | Controller、MQ、Task 设计 | 100 | 60 |

### 设计一致性检查

| 检查项 | 说明 |
|-------|------|
| 命名一致 | 各层命名符合约定 |
| 引用正确 | 章节间引用关系正确 |
| 无遗漏 | PRD 需求全部覆盖 |
| 无矛盾 | 设计决策无冲突 |

### 评分报告格式

```markdown
## 领域设计文档评分报告

### 总分：XX/100

### 章节评分

| 章节 | 得分 | 评价 | 问题 |
|------|------|------|------|
| 第一章：限界上下文 | XX/100 | {通过/需改进} | {问题列表} |
| 第二章：聚合设计 | XX/100 | {通过/需改进} | {问题列表} |
| 第三章：领域服务 | XX/100 | {通过/需改进} | {问题列表} |
| 第四章：应用层 | XX/100 | {通过/需改进} | {问题列表} |
| 第五章：领域事件 | XX/100 | {通过/需改进} | {问题列表} |
| 第六章：入口层 | XX/100 | {通过/需改进} | {问题列表} |

### 综合评分

| 维度 | 得分 | 权重 | 加权得分 |
|------|------|------|----------|
| 第一章 | XX | 15% | XX |
| 第二章 | XX | 25% | XX |
| 第三章 | XX | 10% | XX |
| 第四章 | XX | 15% | XX |
| 第五章 | XX | 10% | XX |
| 第六章 | XX | 10% | XX |
| 设计一致性 | XX | 15% | XX |
| **总分** | - | - | **XX** |

### 结论

- [ ] 总分 ≥90 分，通过评估
- [ ] 总分 <90 分，需修改以下章节：{章节列表}

### 修改建议

针对问题章节的修改建议...
```

---

## 第三章节：Review 流程

### Review 流程概览

```
输入：领域设计文档（评估通过）
  ↓
┌─────────────────────────────────────────────────────────────┐
│ 用户 Review                                                  │
│   - 战略设计是否合理？                                       │
│   - 聚合边界是否正确？                                       │
│   - 命名是否符合规范？                                       │
│   - 约束是否完整？                                           │
│   - 用例覆盖是否充分？                                       │
│   - 接口设计是否符合规范？                                   │
└─────────────────────────────────────────────────────────────┘
  ↓
用户提出修改意见
  ↓
┌─────────────────────────────────────────────────────────────┐
│ 分析问题                                                     │
│   - 识别问题类型（设计问题、遗漏问题、矛盾问题）            │
│   - 定位问题章节                                            │
│   - 分析影响范围                                            │
└─────────────────────────────────────────────────────────────┘
  ↓
输出：问题分析报告 + 修改方案
```

### Review 检查清单

**战略设计（第一章）**：
- [ ] 业务能力识别是否完整？
- [ ] 限界上下文划分是否合理？
- [ ] 上下文映射是否正确？

**聚合设计（第二章）**：
- [ ] 聚合根识别是否正确？
- [ ] 聚合边界是否清晰？
- [ ] 实体与值对象是否区分？

**领域服务（第三章）**：
- [ ] 服务识别是否完整？
- [ ] 服务职责是否清晰？

**应用层（第四章）**：
- [ ] 用户行为与系统行为是否区分？
- [ ] 应用服务命名是否正确？

**领域事件（第五章）**：
- [ ] 事件识别是否完整？
- [ ] 事件命名是否符合规范？

**入口层（第六章）**：
- [ ] 接口路径是否符合规范？
- [ ] 参数命名是否符合规范？
- [ ] 是否使用 Param 格式？

### 问题分析模板

```markdown
## 问题分析报告

### 问题 {N}: {问题描述}

**问题类型**：
- [ ] 设计问题
- [ ] 遗漏问题
- [ ] 矛盾问题
- [ ] 命名问题

**定位章节**：第{X}章

**当前设计**：
{当前的设计内容}

**问题分析**：
{分析为什么这是问题}

**影响范围**：
{分析这个问题影响的其他部分}

**修改方案**：
{具体的修改建议}

**参考原则**：
{相关的原则文档引用}
```

---

## 第四章节：修改流程

### 修改流程概览

```
输入：问题分析报告 + 修改方案
  ↓
┌─────────────────────────────────────────────────────────────┐
│ 增量修改                                                     │
│   - 定位问题章节                                            │
│   - 读取章节内容                                            │
│   - 应用修改方案                                            │
│   - 保持其他章节不变                                        │
└─────────────────────────────────────────────────────────────┘
  ↓
┌─────────────────────────────────────────────────────────────┐
│ 影响分析                                                     │
│   - 检查修改是否影响其他章节                                │
│   - 更新相关引用                                            │
│   - 确保设计一致性                                          │
└─────────────────────────────────────────────────────────────┘
  ↓
┌─────────────────────────────────────────────────────────────┐
│ 重新评分                                                     │
│   - 只对修改的章节重新评分                                  │
│   - 检查修改后的章节是否 ≥60 分                              │
│   - 重新计算总分                                            │
└─────────────────────────────────────────────────────────────┘
  ↓
总分 ≥ 90?
  ├─ 是 → 完成修改，交付文档
  └─ 否 → 返回修改流程，继续迭代
```

### 修改步骤

#### Step 1：定位问题章节

根据问题分析报告，确定需要修改的章节。

#### Step 2：增量修改

**原则**：只修改问题部分，保持其他部分不变

**修改类型**：
- **内容补充**：补充遗漏的设计元素
- **内容修正**：修正错误的设计决策
- **内容删除**：删除冗余或不合理的内容
- **命名修正**：修正不符合规范的命名

#### Step 3：影响分析

**检查项**：
- [ ] 修改是否影响其他章节的引用？
- [ ] 修改是否影响设计一致性？
- [ ] 修改是否引入新的问题？

**更新相关内容**：
- 更新章节间的引用
- 更新相关的设计元素
- 确保命名一致

#### Step 4：重新评分

**评分范围**：
- 只对修改的章节重新评分
- 检查修改后的章节是否 ≥60 分
- 重新计算总分

**评分结果**：
- 修改章节 ≥60 分 → 检查总分
- 修改章节 <60 分 → 继续修改

#### Step 5：迭代直到通过

**终止条件**：总分 ≥90 分

**支持多轮迭代**：可以多次修改、评分，直到满足要求

---

## 工作流质量控制

### 质量关卡

| 关卡 | 位置 | 标准 | 处理 |
|------|------|------|------|
| **关卡1** | 每章生成后 | ≥60 分 | 重生成 |
| **关卡2** | 文档生成后 | ≥90 分 | 修改 |
| **关卡3** | Review 后 | 用户确认 | 迭代 |

### 质量保证机制

**自检机制**：
- 每章生成后自动自检
- 使用检查清单验证
- 使用评分标准量化

**互检机制**：
- 章节间引用检查
- 设计一致性检查
- PRD 覆盖率检查

**Review 机制**：
- 用户 Review 反馈
- 问题分析定位
- 增量修改迭代

### 工作流优化

**并行生成**：
- 独立章节可以并行分析
- 例如：第三章和第五章可以并行分析（都基于第二章）

**增量修改**：
- 只修改问题章节
- 保持其他章节不变
- 减少重复工作

**智能缓存**：
- 缓存已生成的内容
- 避免重复生成
- 提高效率

---

## 支持文档

### 章节指令
- [第一章指令](../chapters/chapter-01-bounded-context.md)
- [第二章指令](../chapters/chapter-02-aggregate.md)
- [第三章指令](../chapters/chapter-03-domain-service.md)
- [第四章指令](../chapters/chapter-04-application.md)
- [第五章指令](../chapters/chapter-05-domain-event.md)
- [第六章指令](../chapters/chapter-06-starter.md)

### 设计原则
- [限界上下文原则](../principles/bounded-context.md)
- [聚合相关原则](../principles/aggregate.md)
- [领域服务原则](../principles/domain-service.md)
- [应用层原则](../principles/application.md)
- [领域事件原则](../principles/domain-event.md)
- [入口层原则](../principles/starter.md)

### 检查清单
- [战略设计检查清单](../checklists/strategic-checklist.md)
- [战术设计检查清单](../checklists/tactical-checklist.md)
- [约束检查清单](../checklists/constraint-checklist.md)
- [用例检查清单](../checklists/usecase-checklist.md)
- [最终审查清单](../checklists/review-checklist.md)

### 评分标准
- [战略设计评分](../scoring/01-strategic-scoring.md)
- [战术设计评分](../scoring/02-tactical-scoring.md)
- [约束评分](../scoring/03-constraint-scoring.md)
- [用例评分](../scoring/04-use-case-scoring.md)

### 模板
- [领域设计文档模板](../assets/templates/domain-design-template.md)
