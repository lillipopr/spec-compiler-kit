# 第五章：领域事件

## 章节目标

完成领域事件设计，包括：
1. **事件列表**：列出所有领域事件
2. **事件详细设计**：设计每个事件的触发条件、携带数据、订阅方

---

## 输入来源

从 PRD 和第二、三章中提取以下信息：

| 来源 | 提取内容 | 转化目标 |
|------|---------|---------|
| PRD 业务流程 | 状态变化 | 领域事件候选 |
| PRD 外部通知 | 跨上下文协作 | 领域事件候选 |
| 第二章 聚合设计 | 聚合状态转移 | 领域事件触发点 |
| PRD 异步处理 | 后台任务 | 领域事件触发点 |

---

## 生成步骤

### Step 1：领域事件识别

**目标**：识别所有领域事件。

#### 1.1 事件识别时机

| 时机 | 说明 | 示例 |
|------|------|------|
| **状态变化** | 聚合状态发生重要变化 | 会员激活、过期 |
| **跨边界协作** | 需要通知其他上下文 | 会员激活通知点券上下文 |
| **异步处理** | 触发后台任务 | 支付成功触发发货 |
| **审计追踪** | 记录关键操作 | 敏感操作审计 |

#### 1.2 事件识别问题清单

对每个业务场景，问以下问题：

```
1. 这个事情重要到需要通知其他部分吗？
   是 → 领域事件候选

2. 这个事情是一个已经发生的事实吗？
   是 → 领域事件候选

3. 其他上下文需要对这个事情做出反应吗？
   是 → 领域事件候选

4. 需要审计追踪这个事情吗？
   是 → 领域事件候选
```

#### 1.3 领域事件 vs 命令

| 维度 | 命令（Command） | 事件（Event） |
|------|-----------------|---------------|
| 时态 | 将来时（要做） | 过去时（已做） |
| 命名 | ActivateMembership | MembershipActivatedEvent |
| 来源 | 用户/系统发起 | 聚合发布 |
| 数量 | 可能多个 | 唯一确定 |
| 处理 | 可以失败 | 必须成功 |
| 示例 | "激活会员" | "会员已激活" |

#### 1.4 事件命名规范

```
格式：{聚合根} + {过去式动词} + Event

示例：
✅ 好的事件命名
- MembershipActivatedEvent（会员已激活）
- OrderPaidEvent（订单已支付）
- CouponExpiredEvent（点券已过期）

❌ 差的事件命名
- ActivateMembershipEvent（命令，不是事件）
- MembershipActivationEvent（缺少动词）
- 会员激活Event（中文，不符合代码规范）
```

**参考文档**：[references/principles/domain-event.md](references/principles/domain-event.md)

---

### Step 2：事件列表

**目标**：列出所有领域事件。

#### 2.1 事件列表表格

| 事件名称 | 触发聚合 | 触发条件 | 携带数据 | 订阅方 |
|---------|---------|---------|---------|--------|
| {事件1} | {聚合A} | {条件描述} | {数据结构} | {订阅方1}, {订阅方2} |
| {事件2} | {聚合B} | {条件描述} | {数据结构} | {订阅方3} |

---

### Step 3：事件详细设计

**目标**：设计每个事件的触发条件、携带数据、订阅方。

#### 3.1 触发条件

{描述事件的触发条件}

**示例**：
- 会员状态从 PENDING 变为 ACTIVE 时
- 订单支付成功时
- 点券过期时

#### 3.2 携带数据

{描述事件携带的数据}

**示例**：
- membershipId: string
- userId: string
- level: MembershipLevel
- activatedAt: Date

#### 3.3 订阅方

{描述事件的订阅方和处理逻辑}

**示例**：
- 点券上下文：开始每日点券发放
- 通知上下文：发送激活通知
- 数据上下文：记录激活日志

---

## 输出格式

### 1. 事件列表

| 事件名称 | 触发条件 | 携带数据 | 订阅方 |
|---------|---------|---------|--------|
| {事件1} | {条件描述} | {数据结构} | {订阅方1}, {订阅方2} |
| {事件2} | {条件描述} | {数据结构} | {订阅方3} |

---

### 2. 单个事件详细设计

#### 2.1 事件：{事件名称}

```
事件名称：{事件名称}
触发聚合：{聚合根}
触发条件：{条件}
携带数据：
  - {字段1}: {类型}
  - {字段2}: {类型}
订阅方：
  - {订阅方1}: {处理逻辑}
  - {订阅方2}: {处理逻辑}
```

**事件定义**

```typescript
interface {事件名称} {
  eventId: string
  {字段1}: {类型1}
  {字段2}: {类型2}
  occurredAt: Date
}
```

**触发条件**

{详细描述触发条件}

**携带数据**

| 字段名 | 类型 | 说明 |
|-------|------|------|
| {字段1} | {类型1} | {字段说明} |
| {字段2} | {类型2} | {字段说明} |

**订阅方**

| 订阅方 | 处理逻辑 |
|-------|---------|
| {订阅方1} | {处理逻辑描述} |
| {订阅方2} | {处理逻辑描述} |

**示例代码**

```typescript
// 发布事件
class Membership {
  activate(): void {
    this.status = MembershipStatus.ACTIVE
    // 发布事件
    this.addEvent(new MembershipActivatedEvent({
      eventId: uuid(),
      membershipId: this.id.value,
      userId: this.userId.value,
      level: this.level,
      occurredAt: new Date()
    }))
  }
}

// 订阅事件
class CouponEventHandler {
  onMembershipActivatedEvent(event: MembershipActivatedEvent): void {
    // 开始每日点券发放
    this.couponService.startDailyGrant(event.membershipId)
  }
}
```

---

## 质量检查

完成本章后，使用以下检查清单自检：

### 检查清单

- [ ] 所有领域事件已识别
- [ ] 事件命名符合规范（过去式）
- [ ] 每个事件都有触发条件
- [ ] 每个事件都有携带数据
- [ ] 每个事件都有订阅方
- [ ] 事件是不可变的
- [ ] 事件是已经发生的事实
- [ ] 事件携带必要业务数据

### 评分标准

使用 [references/scoring/chapter-05-scoring.md](references/scoring/chapter-05-scoring.md) 评分。

**及格线**：60 分

**评分维度**：
- 事件识别（30 分）
- 事件设计（40 分）
- 订阅方设计（30 分）

---

## 常见问题

### Q1: 领域事件和命令的区别？

| 维度 | 命令（Command） | 事件（Event） |
|------|-----------------|---------------|
| 时态 | 将来时（要做） | 过去时（已做） |
| 命名 | ActivateMembership | MembershipActivatedEvent |
| 来源 | 用户/系统发起 | 聚合发布 |
| 数量 | 可能多个 | 唯一确定 |
| 处理 | 可以失败 | 必须成功 |
| 示例 | "激活会员" | "会员已激活" |

### Q2: 领域事件的特征？

| 特征 | 说明 | 示例 |
|------|------|------|
| **已经发生** | 表示过去的事实 | MembershipActivatedEvent（会员已激活） |
| **不可变** | 一旦发生不能改变 | 事件不能被修改 |
| **业务相关** | 表达业务含义 | OrderPaidEvent（订单已支付） |
| **携带数据** | 包含必要业务数据 | 包含 orderId, userId, amount |
| **有唯一标识** | 每个事件有唯一 ID | eventId |

### Q3: 如何识别领域事件？

对每个业务场景，问以下问题：

```
1. 这个事情重要到需要通知其他部分吗？
   是 → 领域事件候选

2. 这个事情是一个已经发生的事实吗？
   是 → 领域事件候选

3. 其他上下文需要对这个事情做出反应吗？
   是 → 领域事件候选

4. 需要审计追踪这个事情吗？
   是 → 领域事件候选
```

### Q4: 事件应该携带多少数据？

**原则**：
- **最少必要数据**：只携带订阅方需要的数据
- **不携带聚合**：不携带整个聚合对象
- **不可变性**：事件数据不可修改

```typescript
// ✅ 正确：只携带必要数据
interface MembershipActivatedEvent {
  eventId: string
  membershipId: string
  userId: string
  level: MembershipLevel
  activatedAt: Date
}

// ❌ 错误：携带整个聚合
interface MembershipActivatedEvent {
  eventId: string
  membership: Membership  // 不应该携带整个聚合
}
```
