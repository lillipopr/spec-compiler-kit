# DDD 实体抽取方法论（3.0 新增）

> **3.0 核心升级**：实体抽取遵循 DDD 原则，不再是简单的名词提取。

## 核心原则

在 DDD 中，实体并不是简单的数据库表映射或名词提取，而是具有**生命周期**且需要**唯一标识**的对象。

### 实体的三个必要条件

| 条件                                   | 说明                                       | 示例                                     |
| -------------------------------------- | ------------------------------------------ | ---------------------------------------- |
| **唯一标识（Identity）**         | 即使属性完全改变，在业务眼中依然是"同一个" | 用户改了名字、换了头像，依然是同一个用户 |
| **生命周期（Lifecycle）**        | 有创建、变化、终结的过程                   | 订单：创建→支付→发货→完成             |
| **状态转移（State Transition）** | 业务需要追踪其状态变化                     | 会员：非会员→生效中→已过期             |

### 实体 vs 值对象

| 类型                             | 特征                      | 示例                   |
| -------------------------------- | ------------------------- | ---------------------- |
| **实体（Entity）**         | 有唯一 ID，需追踪状态变化 | 订单、用户、会员订阅   |
| **值对象（Value Object）** | 无唯一 ID，不可变，可替换 | 收货地址、金额、时间段 |

**判断方法**：如果地址变了，是直接替换掉旧的（值对象），还是追踪"地址"这个对象本身的生命周期（实体）？

---

## 实体抽取步骤

### Step 1：从需求中识别候选实体

从需求描述中提取名词，但**不要直接当作实体**：

```
需求："用户订阅会员，每天刷新 100 点券"

候选名词：用户、会员、点券、订阅、刷新
```

### Step 2：用三个必要条件筛选

对每个候选名词，问三个问题：

| 候选         | 有唯一 ID？       | 有生命周期？        | 有状态转移？  | 结论             |
| ------------ | ----------------- | ------------------- | ------------- | ---------------- |
| 用户         | ✅ userId         | ✅ 注册→使用→注销 | ✅ 活跃/冻结  | **实体**   |
| 会员订阅     | ✅ subscriptionId | ✅ 创建→生效→过期 | ✅ M0/M1/M2   | **实体**   |
| 点券发放记录 | ✅ grantId        | ✅ 创建后不可变     | ❌ 无状态转移 | **值对象**      |
| 点券余额     | ❌ 无独立 ID      | ❌ 是用户的属性     | ❌ 无状态转移 | **值对象** |
| 刷新         | ❌ 是行为         | -                   | -             | **行为**   |

### Step 3：确定实体的聚合关系

**聚合根（Aggregate Root）**：谁负责维护这组数据的一致性？

```
用户（聚合根）
├── 会员订阅（实体）
└── 点券账户（值对象）
    └── 点券发放记录（实体，但由用户聚合管理）
```

---

## 行为抽取

### 行为分类

DDD 将行为根据其性质和跨度，分配到不同的层级中：

| 类型               | 触发方        | 职责归属       | 示例                       |
| ------------------ | ------------- | -------------- | -------------------------- |
| **用户行为** | 用户/外部系统 | 应用层（意图） | 订阅会员、续费、取消       |
| **系统行为** | 定时任务/事件 | 领域层（事实） | 每日刷新点券、会员到期处理 |

### 行为归属判断

#### A. 领域模型内的行为（充血模型）

**逻辑**：如果一个行为只涉及单个实体的属性变更，且不依赖外部服务。

**归属**：直接写在**实体（Entity）**或**聚合根（Aggregate Root）**的方法里。

**例子**：`Order.changeAddress()` 或 `User.updatePassword()`

#### B. 领域服务（Domain Service）

**逻辑**：当一个行为涉及**多个聚合根**的协作，或者该行为本身不属于任何特定实体时。

**归属**：抽取为**领域服务**。

**例子**："转账"操作涉及 A 账户和 B 账户，应抽取为 `TransferService`。

#### C. 应用服务（Application Service）

**逻辑**：负责编排业务流程、权限校验、事务控制以及与外部系统的交互。它不包含核心业务逻辑。

**归属**：**应用层**。

**例子**："下单用例"需要调用库存服务校验、调用订单聚合创建订单、发送通知邮件。

---

## 实体抽取示例

### 示例：会员点券功能

**需求**：用户订阅会员，每天刷新 100 点券

#### Step 1：候选名词

用户、会员、订阅、点券、刷新

#### Step 2：三条件筛选

| 候选         | 唯一 ID | 生命周期            | 状态转移    | 结论               |
| ------------ | ------- | ------------------- | ----------- | ------------------ |
| 用户         | ✅      | ✅                  | ✅          | 实体（聚合根）     |
| 会员订阅     | ✅      | ✅ 创建→生效→过期 | ✅ M0/M1/M2 | 实体               |
| 点券发放记录 | ✅      | ✅ 创建后不可变     | ❌          | 值对象             |
| 点券余额     | ❌      | ❌                  | ❌          | 值对象（用户属性） |

#### Step 3：最终实体列表

| 实体名称                    | 唯一标识     | 生命周期         | 状态      | 聚合关系     |
| --------------------------- | ------------ | ---------------- | --------- | ------------ |
| 用户（User）                | userId       | 注册→使用→注销 | 活跃/冻结 | 聚合根       |
| 会员订阅（Membership）      | membershipId | 创建→生效→过期 | M0/M1/M2  | 属于用户聚合 |
| 点券发放记录（CouponGrant） | grantId      | 创建后不可变     | 无        | 属于用户聚合 |

#### Step 4：行为列表

**用户行为**（应用层意图）：

- **订阅会员**：用户发起订阅请求
- **续费会员**：用户发起续费请求
- **取消订阅**：用户发起取消请求

**系统行为**（领域层事实）：

- **每日刷新点券**：定时任务触发，为 M1 状态用户发放点券
- **会员到期处理**：定时任务触发，将过期会员状态改为 M2

---

## 审核检查点

- [ ] 每个实体都有唯一标识（ID）
- [ ] 每个实体都有明确的生命周期
- [ ] 有状态转移的实体已定义状态机
- [ ] 值对象与实体已正确区分
- [ ] 聚合关系已明确
- [ ] 行为已分类为用户行为和系统行为
- [ ] 行为的职责归属已明确（应用层/领域层）

---

## 常见错误

### ❌ 错误 1：把所有名词都当作实体

```
错误：用户、会员、点券、余额、刷新 → 全部当作实体
正确：用三条件筛选，区分实体、值对象、行为
```

### ❌ 错误 2：忽略生命周期

```
错误：只看"有没有这个东西"，不看"它怎么变化"
正确：实体必须有创建、变化、终结的过程
```

### ❌ 错误 3：混淆意图和事实

```
错误：把"用户点击订阅按钮"当作领域事件
正确：
- 意图（应用层）：用户发起订阅请求
- 事实（领域层）：订阅成功，会员状态变为 M1
```

---

**下一步** → [Phase 1: 问题建模](../02-compilation-phases/phase-1-modeling.md)
