# Phase 1: 问题建模（跨端唯一）

> **跨端唯一真理**：本文档定义的实体、状态、不变量适用于所有端（iOS/后端/前端）。
> 各端实现时必须遵守这些约束，不得自行添加或修改业务逻辑。

## 目标

将模糊的业务需求转化为清晰的状态空间定义，回答"系统有哪些状态"而不是"系统怎么实现"。

**关键原则**：问题建模是跨端唯一的，不区分后端、iOS、前端。所有端共享同一份问题建模文档。

## 核心产出

| 产出物 | 说明 | 示例 |
|--------|------|------|
| 实体列表 | 业务中的核心对象（遵循 DDD 原则） | 用户、订单、会员订阅 |
| 状态定义 | 每个实体的状态机 | 订单：待支付→已支付→已发货 |
| 行为列表 | 用户行为 + 系统行为 | 用户下单、系统发货通知 |
| 不变量 | 系统必须满足的约束 | 库存不能为负 |
| 状态转移 | 合法的状态变化路径 | 待支付→已支付（支付成功） |
| 禁止态 | 系统不允许进入的状态 | 已发货→待支付 |

---

## 建模步骤

### Step 1: 识别实体（DDD 原则）

> **3.0 升级**：实体抽取遵循 DDD 原则，不再是简单的名词提取。

从需求描述中提取名词，用**三个必要条件**筛选：

| 条件 | 说明 | 判断方法 |
|------|------|---------|
| **唯一标识** | 有独立的 ID | 即使属性变了，业务上还是"同一个"吗？ |
| **生命周期** | 有创建、变化、终结 | 它会经历哪些阶段？ |
| **状态转移** | 需要追踪状态变化 | 业务关心它的状态吗？ |

**示例**：

```
需求："用户可以购买商品，支付后商家发货"

候选名词：用户、商品、支付、商家、发货

三条件筛选：
| 候选 | 唯一 ID | 生命周期 | 状态转移 | 结论 |
|------|--------|---------|---------|------|
| 用户 | ✅ | ✅ | ✅ | 实体 |
| 商品 | ✅ | ✅ | ✅ | 实体 |
| 订单（隐含） | ✅ | ✅ | ✅ | 实体 |
| 支付 | ❌ 是行为 | - | - | 行为 |
| 发货 | ❌ 是行为 | - | - | 行为 |
```

**详细方法论** → 见 [entity-extraction.md](../03-methodology/entity-extraction.md)

### Step 2: 枚举状态

为每个实体定义完整的状态空间：

```
订单状态：
- O0: 待支付（Created）
- O1: 已支付（Paid）
- O2: 已发货（Shipped）
- O3: 已完成（Completed）
- O4: 已取消（Cancelled）
- O5: 已退款（Refunded）
```

**状态定义原则**：
- 状态必须互斥（同一时刻只能处于一个状态）
- 状态必须完备（覆盖所有可能情况）
- 使用状态码 + 状态名的格式

### Step 3: 定义行为（用户行为 + 系统行为）

> **3.0 升级**：行为明确分为用户行为和系统行为，区分意图和事实。

| 类型 | 触发方 | 职责归属 | 示例 |
|------|--------|---------|------|
| **用户行为** | 用户/外部系统 | 应用层（意图） | 下单、支付、取消 |
| **系统行为** | 定时任务/事件 | 领域层（事实） | 订单超时取消、库存扣减 |

**示例**：

```
用户行为（意图）：
- 用户下单：用户发起创建订单请求
- 用户支付：用户发起支付请求
- 用户取消：用户发起取消订单请求

系统行为（事实）：
- 支付成功：支付回调确认，订单状态变为已支付
- 商家发货：商家操作，订单状态变为已发货
- 订单超时：定时任务触发，超时未支付订单自动取消
```

### Step 4: 定义不变量

识别系统在任何时刻都必须满足的约束：

```
INV-01: 订单金额 = Σ(商品单价 × 数量)
INV-02: 库存数量 >= 0
INV-03: 已支付订单必须有支付记录
INV-04: 已发货订单必须有物流单号
```

**不变量分类**：
- 数据完整性：字段非空、格式正确
- 业务规则：金额计算、状态约束
- 一致性约束：跨实体的关联关系

### Step 5: 画状态转移图

定义合法的状态变化路径：

```
O0(待支付) --[支付成功]--> O1(已支付)
O0(待支付) --[取消订单]--> O4(已取消)
O0(待支付) --[超时未支付]--> O4(已取消)
O1(已支付) --[商家发货]--> O2(已发货)
O1(已支付) --[申请退款]--> O5(已退款)
O2(已发货) --[确认收货]--> O3(已完成)
```

**状态转移表格式**：

| 当前状态 | 触发行为 | 行为类型 | 目标状态 | 前置条件 |
|----------|----------|---------|----------|----------|
| O0 待支付 | 支付成功 | 系统 | O1 已支付 | 支付金额 = 订单金额 |
| O0 待支付 | 取消订单 | 用户 | O4 已取消 | 无 |
| O0 待支付 | 超时未支付 | 系统 | O4 已取消 | 创建时间 > 30分钟 |
| O1 已支付 | 商家发货 | 用户 | O2 已发货 | 有物流单号 |

### Step 6: 识别禁止态

明确系统不允许进入的状态：

```
禁止态-1: 已发货订单回退到待支付
禁止态-2: 已取消订单继续发货
禁止态-3: 库存为负数
禁止态-4: 订单金额为负数
```

---

## 闸口检查

Phase 1 完成后，必须通过以下检查：

- [ ] 所有核心实体已识别（遵循 DDD 三条件）
- [ ] 每个实体有完整的状态定义
- [ ] 行为已分类为用户行为和系统行为
- [ ] 不变量清单完整（至少 3 条）
- [ ] 状态转移图无遗漏
- [ ] 禁止态已明确
- [ ] **跨端一致性确认**：所有端使用同一份建模文档

## 自我验证

在进入下一阶段前，确认：

- [ ] 每个实体都有唯一 ID、生命周期、状态转移
- [ ] 值对象与实体已正确区分
- [ ] 每个实体至少有 2 个状态（初始状态 + 至少一个转移状态）
- [ ] 不变量至少 3 条，覆盖结构、业务、版本三类
- [ ] 状态转移表无孤岛状态（无法到达或离开的状态）
- [ ] 每个禁止态都有对应的 Bad Case 计划
- [ ] **无平台特定逻辑**：建模文档不包含任何平台特定的实现细节

---

## 文档模板

```markdown
# {功能名称} - 问题建模文档

> **跨端唯一真理**：本文档定义的实体、状态、不变量适用于所有端（iOS/后端/前端）。
> 各端实现时必须遵守这些约束，不得自行添加或修改业务逻辑。

## 1. 核心实体列表（DDD 原则）

| 实体名称 | 唯一标识 | 生命周期 | 状态 | 聚合关系 |
|---------|---------|---------|------|---------|
| {实体1} | {id字段} | {创建→...→终结} | {状态列表} | {聚合根/属于XX} |
| {实体2} | {id字段} | {创建→...→终结} | {状态列表} | {聚合根/属于XX} |

### 值对象列表

| 值对象名称 | 所属实体 | 说明 |
|-----------|---------|------|
| {值对象1} | {实体} | {说明} |

## 2. 状态定义表

### {实体1}状态

| 状态码 | 状态名称 | 含义 | 可转移状态 |
|-------|---------|------|-----------|
| S0 | {状态名} | {含义} | S1, S9 |
| S1 | {状态名} | {含义} | S2 |

## 3. 行为列表

### 用户行为（应用层意图）

| 行为名称 | 触发方 | 描述 | 影响的实体 |
|---------|--------|------|-----------|
| {行为1} | 用户 | {描述} | {实体} |
| {行为2} | 外部系统 | {描述} | {实体} |

### 系统行为（领域层事实）

| 行为名称 | 触发方式 | 描述 | 影响的实体 |
|---------|---------|------|-----------|
| {行为1} | 定时任务 | {描述} | {实体} |
| {行为2} | 事件监听 | {描述} | {实体} |

## 4. 不变量清单

### 结构约束
- **INV-01**：{约束描述}
- **INV-02**：{约束描述}

### 业务约束
- **INV-03**：{约束描述}
- **INV-04**：{约束描述}

### 版本约束
- **INV-05**：{约束描述}

## 5. 状态转移表

| 当前状态 | 触发行为 | 行为类型 | 目标状态 | 约束条件 |
|---------|---------|---------|---------|---------|
| S0 | {行为} | 用户/系统 | S1 | {条件} |
| S1 | {行为} | 用户/系统 | S2 | {条件} |

## 6. 禁止态说明

- **禁止态-1**：{描述}
- **禁止态-2**：{描述}

## 7. 跨端一致性声明

本文档适用于以下所有端：
- [ ] 后端（Java DDD）
- [ ] iOS（SwiftUI MVVM）
- [ ] 前端（Vue 3）
- [ ] 小程序

各端实现时必须：
1. 遵守本文档定义的所有不变量
2. 不得自行添加业务逻辑
3. 状态转移必须与本文档一致
```

---

**下一步** → [Phase 2: 可执行约束](phase-2-constraints.md)
