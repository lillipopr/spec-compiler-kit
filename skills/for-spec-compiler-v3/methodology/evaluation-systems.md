# 判断型/评估型系统特化指南

## 适用场景

当你正在开发的系统属于以下类型时，需要阅读本指南：

- ✅ **测评系统**：心理测评、能力评估、性格测试
- ✅ **风控系统**：信用评分、欺诈检测、风险评估
- ✅ **推荐系统**：个性化推荐、匹配算法
- ✅ **审核系统**：内容审核、合规检查
- ✅ **画像系统**：用户画像、标签生成
- ✅ **诊断系统**：故障诊断、医疗诊断、问题定位

---

## 核心差异：判断型 vs 普通系统

| 维度 | 普通系统 | 判断型系统 |
|------|---------|-----------|
| **核心关注** | 状态转移为主 | 推导链为主 |
| **结果特性** | 结果可计算 | 结果需解释 |
| **规则稳定性** | 相对稳定 | 频繁升级（版本化） |
| **可逆性** | 回滚操作即可 | 需保留规则版本 |
| **验证方式** | 功能测试为主 | 回放 + 差异分析 |

---

## 额外建模要素

判断型系统除了常规的状态、不变量、行为外，还需建模：

### 1. 评估坐标系（Dimensions & Metrics）

这是判断型系统的"世界观假设"。

#### 维度（Dimension）

评价空间的坐标轴，一旦变更等于换一套理论。

**示例（择偶观测评）**：

| 维度 ID | 含义 |
|---------|------|
| D1 | 情感需求 |
| D2 | 现实条件 |
| D3 | 成长与价值观 |
| D4 | 安全感来源 |

#### 指标（Metric）

维度的可观测量，如何"看到"这个维度。

| 指标 ID | 描述 | 来源题目 | 计算方式 |
|---------|------|----------|---------|
| M1 | 情感依赖度 | Q1, Q5 | (Q1 + Q5) / 2 |
| M2 | 物质重视度 | Q2, Q7 | Q2 * 0.6 + Q7 * 0.4 |

**关键约束**：
- INV-1：每道题只能归属一个指标
- INV-2：指标必须能被量化

#### 标签（Tag）

人类可读的结论，由指标区间确定。

| 标签 | 触发条件 |
|------|---------|
| 情感导向型 | M1 ≥ 70 AND M2 ≤ 40 |
| 现实稳定型 | M1 ≤ 40 AND M2 ≥ 70 |

**关键约束**：
- INV-3：标签必须由指标区间唯一确定
- INV-4：标签区间不能重叠

---

### 2. 推导管线（Derivation Pipeline）

这是判断型系统的核心，**必需显性建模**。

#### 标准推导链

```
原始答案（Submission）
  ↓
题目得分（QuestionScore）
  ↓
指标计算（MetricValue）
  ↓
维度聚合（DimensionScore）
  ↓
标签判定（TagAssignment）
  ↓
最终报告（Report）
```

#### 每层的要求

| 层级 | 输入 | 输出 | 可测试性 |
|------|------|------|---------|
| QuestionScore | 答案 + 题目配置 | 每题分数 | ✅ 独立测试 |
| MetricValue | 题目分数 + 指标定义 | 指标值 | ✅ 独立测试 |
| DimensionScore | 指标值 + 维度定义 | 维度分数 | ✅ 独立测试 |
| TagAssignment | 维度分数 + 标签规则 | 标签列表 | ✅ 独立测试 |
| ReportAssembler | 所有数据 | 最终报告 | ✅ 端到端测试 |

**关键原则**：
- 每一层输入/输出明确
- 每一层可独立测试
- 每一层可被替换（版本化）

---

### 3. 可解释性约束（极重要）

判断型系统的核心价值在于"可解释"。

#### 可解释性不变量

```
INV-5：每个标签必须能回溯到具体指标区间
INV-6：报告必须能解释"为什么是这个结果"
INV-7：每个维度得分必须能追溯到具体题目
```

#### 验证标准

**能否回答"为什么"**？

```gherkin
Case：验证可解释性
Given：用户获得标签"情感导向型"
When：用户问"为什么是这个标签？"
Then：系统能回答：
  "因为您的情感依赖度得分是 85（来自 Q1 和 Q5），
   高于现实条件得分 40，所以判断为情感导向型"
```

---

### 4. 事实 vs 结果分离

这是支持规则升级的关键。

#### 事实实体（不可变）

```
Submission（用户答题事实）
  ├─ 用户 ID
  ├─ 提交时间
  ├─ 每题原始选择
  └─ 永远不可修改
```

#### 推导结果实体（可版本化）

```
MetricResult（指标计算结果）
  ├─ submission_id
  ├─ rule_version: "v1.0.0"
  ├─ metric_values: {...}
  └─ 可以重算、版本升级

DimensionResult（维度聚合结果）
TagResult（标签判定结果）
Report（最终报告）
```

**关键设计**：
- 事实只在 Submission 表
- 所有计算结果都带 `rule_version`
- 规则升级时，可以重算结果

---

## 用例设计特化

判断型系统需要额外的用例类型：

### 1. 推导路径用例

```gherkin
Case：完整推导链
Given：
  - 答案集 A
  - 规则版本 v1.0

When：
  - 执行评估

Then：
  - QuestionScore: {Q1: 5, Q2: 3, ...}
  - MetricValue: {M1: 80, M2: 30, ...}
  - DimensionScore: {情感: 75, 现实: 40}
  - TagResult: ["情感导向型", "成长伴侣型"]
```

### 2. 回放用例（必需）

```gherkin
Case：历史结果回放
Given：
  - 历史答题 Submission-123
  - 规则版本 v1.0.0
  - 原始报告分数：85

When：
  - 用 v1.0.0 重算

Then：
  - 新报告分数 = 85
  - 所有指标一致
  - 所有标签一致
```

### 3. 规则升级用例

```gherkin
Case：规则 v1 → v2 升级
Given：
  - 同一 Submission
  - v1 规则：M1 = Q1 + Q3
  - v2 规则：M1 = Q1 + Q3 + Q7

When：
  - 分别用 v1 和 v2 计算

Then：
  - v2_M1 ≥ v1_M1
  - 差异可解释：+ Q7 的贡献
  - 两个版本的结果都有记录
```

### 4. 可解释性用例

```gherkin
Case：验证可解释性
Given：
  - 某用户的评估报告

When：
  - 请求解释某标签

Then：
  - 返回具体的指标值
  - 返回影响的题目列表
  - 返回判定逻辑
```

---

## 工件推导特化

### 推导管线实现

```
ScoringPipeline
  ├─ QuestionScorer（题目评分）
  ├─ MetricCalculator（指标计算）
  ├─ DimensionAggregator（维度聚合）
  ├─ TagAssigner（标签判定）
  └─ ReportAssembler（报告组装）
```

**每个组件的要求**：
- 纯函数（无副作用）
- 输入/输出明确
- 可独立测试
- 版本化配置

### 接口设计

```java
// 领域层接口
EvaluationResult evaluate(
    Submission submission,
    EvaluationRuleVersion version
)

Report rebuildReport(
    String submissionId,
    String ruleVersion
)
```

---

## 版本管理策略

### 规则版本冻结

```java
EvaluationRule {
    version: "v1.0.0"
    definitions: {
        dimensions: [...],
        metrics: [...],
        tags: [...]
    }
    createdAt: "2026-01-27"
    status: "ACTIVE" // or "DEPRECATED"
}
```

### Submission 绑定版本

```java
Submission {
    id: "12345"
    answers: {...}
    ruleVersion: "v1.0.0" // 生成时的规则版本
    createdAt: "2026-01-27"
}
```

### 重算策略

**场景 1：Bug 修复**
- 小改动：重算所有 Submission
- 用例验证：回放用例通过

**场景 2：规则优化**
- 大改动：历史结果保持不变
- 新 Submission 用新规则
- 用户可选重新评估

---

## 验证清单

判断型系统上线前，必须通过以下检查：

### 建模检查
- [ ] 评估坐标系（维度/指标/标签）已定义
- [ ] 推导管线已显性建模
- [ ] 每层输入/输出明确

### 约束检查
- [ ] INV-1: 每题只归属一个指标
- [ ] INV-2: 标签区间不重叠
- [ ] INV-3: 结果可回溯
- [ ] INV-4: 结果可重算

### 用例检查
- [ ] 正向推导用例
- [ ] 边界用例
- [ ] Bad Case
- [ ] 回放用例（必需）
- [ ] 规则升级用例（必需）

### 工件检查
- [ ] 事实与结果分离
- [ ] 推导管线可测试
- [ ] 规则版本可配置
- [ ] 报告可解释

---

## 完整示例：择偶观测评

见主文档中的"择偶观测评完整建模"部分，包括：

1. **问题建模**：5 个维度、10 个指标、4 个标签
2. **不变量**：7 条可执行约束
3. **推导管线**：5 层清晰结构
4. **用例**：覆盖推导、回放、升级
5. **工件**：实体、接口、管线设计

---

## 反模式识别

当出现以下情况时，说明系统设计有问题：

- ❌ 规则硬编码在代码里
- ❌ 无法解释"为什么是这个结果"
- ❌ 规则升级后历史结果不一致
- ❌ 指标和题目关系混乱
- ❌ 标签判定逻辑分散

正确做法：
- ✅ 规则配置化、版本化
- ✅ 结果可解释、可追溯
- ✅ 事实与结果分离
- ✅ 推导管线清晰
- ✅ 用例覆盖完整
